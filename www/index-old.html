<!DOCTYPE html>
<html lang="es">
  <head>
    <meta
      http-equiv="Content-Security-Policy"
      content="
  default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
  connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://firebaseinstallations.googleapis.com;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.gstatic.com https://www.googletagmanager.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com;
  img-src 'self' data: blob: https://*.googleapis.com https://*.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com;
  frame-src 'self' https://www.youtube.com https://trytako.com;
  child-src 'self';
  manifest-src 'self';
  worker-src 'self';
  font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com;
  upgrade-insecure-requests;
  block-all-mixed-content;
"
    />
    <meta charset="UTF-8" />
    <title>PowerGreen - Reduce Tu Huella de Carbono</title>
    <script type="module">
      // Importa todas las funciones necesarias
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
      // A√±ade esta l√≠nea para importar Firestore
      import {
        getFirestore,
        collection,
        doc,
        setDoc,
        getDoc,
        query,
        orderBy,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHGXC-YZXmNSAN5JfPdcg89zQwPjbAD04",
        authDomain: "powergreen-683b8.firebaseapp.com",
        projectId: "powergreen-683b8",
        storageBucket: "powergreen-683b8.appspot.com",
        messagingSenderId: "935756958478",
        appId: "1:935756958478:web:e8697d296a03185a54a55f",
        measurementId: "G-2787W6MD4X",
      };

      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const storage = getStorage(app);
      // A√±ade esta l√≠nea para inicializar Firestore
      const db = getFirestore(app);

      // Exp√≥n las funciones necesarias al scope global
      window.firebaseAuth = {
        auth,
        signInWithEmailAndPassword: (email, password) =>
          signInWithEmailAndPassword(auth, email, password),
        createUserWithEmailAndPassword: (email, password) =>
          createUserWithEmailAndPassword(auth, email, password),
        signOut: () => signOut(auth),
        onAuthStateChanged: (callback) => onAuthStateChanged(auth, callback),
        // A√±ade Firestore a las funciones expuestas
        firestore: {
          db,          api: { doc, setDoc, getDoc, collection, query, orderBy, getDocs },
          saveFootprint: async (userId, footprintData) => {
            try {
              // Usamos la fecha como ID del documento para facilitar la actualizaci√≥n diaria
              const footprintRef = doc(
                db,
                "users",
                userId,
                "footprints",
                footprintData.date
              );

              await setDoc(footprintRef, footprintData, { merge: true }); // merge: true permite actualizar sin borrar otros campos

              return true;
            } catch (error) {
              console.error("Error saving footprint:", error);
              return false;
            }
          },
          testConnection: async () => {
            try {
              const testRef = doc(db, "test", "connection");
              await setDoc(testRef, {
                test: "Conexi√≥n exitosa",
                timestamp: new Date(),
              });
              const docSnap = await getDoc(testRef);
              return docSnap.exists();
            } catch (error) {
              console.error("Error testing connection:", error);
              return false;
            }
          },
          getFootprintHistory: async (userId) => {
            try {
              const footprintsRef = collection(
                db,
                "users",
                userId,
                "footprints"
              );
              const q = query(footprintsRef, orderBy("timestamp", "desc"));
              const querySnapshot = await getDocs(q);

              const history = [];
              querySnapshot.forEach((doc) => {
                history.push(doc.data());
              });

              return history;
            } catch (error) {
              console.error("Error getting footprint history:", error);
              return [];
            }
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary:   "#254D32", // verde bosque (para botones/accents principales)
          secondary: "#6B7F5B", // verde oliva/salvia (para elementos secundarios)
          accent:    "#A3B18A", // salvia claro (chips, badges, resaltados suaves)
          ink:       "#1F3D2B", // texto principal (verde muy oscuro legible)
          surface:   "#F8EBCF", // crema (fondos/containers claros)
        },
        boxShadow: {
          soft: "0 10px 30px rgba(0,0,0,.08)",
        },
        borderRadius: {
          "2xl": "1.25rem",
        },
          },
        },
        darkMode: "class",
      };

      // Detectar modo oscuro
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        document.documentElement.classList.add("dark");
      }
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          if (event.matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        });
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .progress-bar {
        transition: width 1s ease-in-out;
      }

      /* Estilo personalizado para el control deslizante */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #d7dcdf;
      }
      .info-tooltip {
        position: relative;
        cursor: pointer;
      }

      .info-tooltip:hover::after {
        content: attr(data-info);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        padding: 8px;
        background: #2c3e50;
        color: white;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #2ecc71;
        cursor: pointer;
      }

      .hidden {
        display: none !important;
      }

      .dark input[type="range"] {
        background: #4b5563;
      }

      .challenge-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .challenge-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .dark .challenge-card:hover {
        box-shadow: 0 10px 20px rgba(255, 255, 255, 0.05);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }
      /* Efectos para el topbar */
      .tab-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }

      /* Efectos para las tarjetas */
      .tip-card:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      /* Efectos para botones */
      button:hover {
        transform: translateY(-1px);
      }

      /* Efectos para inputs */
      input:hover,
      select:hover {
        border-color: #2ecc71;
      }
      /* Animaciones */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .animate-fade-in {
        animation: fadeIn 1s ease-out;
      }

      .animate-slide-up {
        animation: slideUp 0.8s ease-out forwards;
        opacity: 0;
      }

      .animate-bounce {
        animation: bounce 2s infinite;
      }
      /* Animaci√≥n para el modal */
      #contactModal {
        transition: opacity 0.3s ease;
      }

      #contactModal > div {
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }

      #contactModal:not(.hidden) > div {
        transform: scale(1);
      }
      /* Animaci√≥n de spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Transici√≥n para el loader global */
      #globalLoader {
        transition: opacity 0.5s ease-out;
      }
      /* --- Carrusel Diario (scroll snap) --- */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

.pg-carousel {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  padding: .25rem .25rem 1rem;
}
.pg-card {
  scroll-snap-align: start;
  min-width: 85%;
  max-width: 85%;
  background: white;
  border-radius: 1.25rem;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  padding: 1rem;
  transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
}
.dark .pg-card { background: #111827; box-shadow: 0 10px 30px rgba(255,255,255,.06); }
.pg-card:hover { transform: translateY(-3px); box-shadow: 0 14px 34px rgba(0,0,0,.12); }

.pg-card {
  scroll-snap-align: center;
  min-width: 90%;
  max-width: 90%;
  min-height: 280px;   /* <- agrega altura m√≠nima */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: white;
  border-radius: 1.25rem;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  padding: 1.25rem;
  transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
}
.dark .pg-card-icon { border-radius: 1.25rem; background: rgba(187, 221, 199, 0.13); }

/* Modal diario */
.pg-modal-backdrop { background: rgba(0,0,0,.5); }

    </style>
  </head>
  <body class="bg-surface dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    
<!-- Splash/Loader con video + logo -->
<div id="globalLoader" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 transition-opacity duration-500">
  <div class="flex flex-col items-center">
    <!-- Si pones el archivo assets/video/splash.mp4 se reproduce; si no, queda el logo animado -->
    <video id="splashVideo" class="w-40 h-40 rounded-2xl shadow-soft mb-4" autoplay muted playsinline preload="auto">
      <source src="" type="video/mp4" />
    </video>

    <!-- Logo huella + texto -->
    <div class="flex items-center gap-3 text-white">
      <svg width="42" height="42" viewBox="0 0 24 24" class="animate-pulse">
        <path fill="currentColor" d="M7 20c0-2 2-4 5-4s5 2 5 4-2 4-5 4-5-2-5-4Zm7.5-10.5a1.5 1.5 0 1 1 3.001.001A1.5 1.5 0 0 1 14.5 9.5ZM12 2a2 2 0 1 1 0 4a2 2 0 0 1 0-4Zm-5 3a1.75 1.75 0 1 1 0 3.5A1.75 1.75 0 0 1 7 5Zm-2 6a2 2 0 1 1 0 4a2 2 0 0 1 0-4Z"/>
      </svg>
      <span class="text-2xl font-semibold tracking-wide">PowerGreen</span>
    </div>

  </div>
</div>

    <header class="sticky top-0 bg-primary text-white/95 shadow-md z-40">
  <div class="max-w-5xl mx-auto px-4">
    <!-- App bar -->
    <div class="h-14 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="index.png" alt="PowerGreen" class="w-9 h-9 rounded-md" />
        <h1 class="text-lg font-semibold tracking-wide">PowerGreen</h1>
      </div>

      <div class="flex items-center gap-2">
        <!-- Tema -->
        <button id="themeToggle"
          class="px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm"
          title="Cambiar tema" aria-label="Cambiar tema">üåì</button>

        <!-- Men√∫ (mobile) -->
        <button id="menuToggle" class="md:hidden px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 focus:outline-none" aria-label="Abrir men√∫">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 6h16M4 12h16m0 6H4" />
          </svg>
        </button>

        <!-- Cerrar sesi√≥n (sutil, no rojo) -->
        <button id="logoutBtn"
          class="hidden md:inline-flex px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm">
          Cerrar sesi√≥n
        </button>
      </div>
    </div>

    <!-- Tabs (chips) -->
    <nav id="mobileMenu"
         class="hidden md:block overflow-x-auto no-scrollbar py-2 -mx-1">
      <ul class="grid grid-cols-2 md:flex md:flex-wrap gap-2 px-1">
        <li><button class="tab-button px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white/90 whitespace-nowrap focus:outline-none" data-tab="calculator">Calculadora</button></li>
        <li><button class="tab-button px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white/90 whitespace-nowrap focus:outline-none" data-tab="tips">Consejos</button></li>
        <li><button class="tab-button px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white/90 whitespace-nowrap focus:outline-none" data-tab="challenges">Retos</button></li>
        <li><button class="tab-button px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white/90 whitespace-nowrap focus:outline-none" data-tab="progress">Progreso</button></li>
        <li><button class="tab-button px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white/90 whitespace-nowrap focus:outline-none" data-tab="daily">Diario</button></li>

        <!-- Cerrar sesi√≥n extra en mobile (dentro del men√∫) -->
        <li class="md:hidden">
          <button id="logoutBtnMobile"
            class="w-full px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm">
            Cerrar sesi√≥n
          </button>
        </li>
      </ul>
    </nav>
  </div>
</header>


    <main class="container mx-auto px-4 py-6">
      <!-- Secci√≥n de Login -->
      <section id="auth-section" class="py-6">
        <div
          class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden p-8"
        >
          <div class="text-center mb-8">
            <img
              src="index.png"
              alt="PowerGreen Logo"
              class="w-16 h-16 mx-auto mb-4"
            />
            <h2 class="text-3xl font-bold text-primary">
              Bienvenido a PowerGreen
            </h2>
            <p class="text-gray-600 dark:text-gray-400">
              Reduce tu huella de carbono
            </p>
          </div>

          <div id="loginForm" class="space-y-6 animate-fade-in">
            <div>
              <label class="block text-sm font-medium mb-1"
                >Correo electr√≥nico</label
              >
              <input
                type="email"
                id="loginEmail"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Contrase√±a</label>
              <input
                type="password"
                id="loginPassword"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <button
              id="loginBtn"
              class="w-full bg-primary hover:bg-secondary text-white py-3 rounded-lg transition-all"
            >
              Iniciar Sesi√≥n
            </button>
            <p class="text-center text-sm">
              ¬øNo tienes cuenta?
              <button id="showRegister" class="text-primary font-medium">
                Reg√≠strate
              </button>
            </p>
          </div>

          <div id="registerForm" class="space-y-6 hidden animate-fade-in">
            <!-- <div>
                        <label class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="registerName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700">
                    </div> -->
            <div>
              <label class="block text-sm font-medium mb-1"
                >Correo electr√≥nico</label
              >
              <input
                type="email"
                id="registerEmail"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Contrase√±a</label>
              <input
                type="password"
                id="registerPassword"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
              <p class="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
            </div>
            <button
              id="registerBtn"
              class="w-full bg-accent hover:bg-blue-600 text-white py-3 rounded-lg transition-all"
            >
              Crear Cuenta
            </button>
            <p class="text-center text-sm">
              ¬øYa tienes cuenta?
              <button id="showLogin" class="text-primary font-medium">
                Inicia Sesi√≥n
              </button>
            </p>
          </div>

          <div id="authMessage" class="mt-4 text-center hidden"></div>
        </div>
      </section>
      <!-- Secci√≥n de Bienvenida -->
      <section id="welcome" class="text-center py-10 px-4 hidden">
        <div class="max-w-4xl mx-auto">
          <h1 class="text-4xl md:text-5xl font-bold mb-6 text-primary">
            PowerGreen
          </h1>

          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-left animate-fade-in"
          >
            <h2 class="text-2xl font-bold mb-4 text-primary">
              ¬øQu√© es la Huella de Carbono?
            </h2>
            <p class="mb-4">
              La huella de carbono es un indicador ambiental que mide la
              cantidad total de emisiones de gases de efecto invernadero (GEI),
              expresadas en toneladas de di√≥xido de carbono equivalente (CO‚ÇÇe),
              que son liberadas directa o indirectamente a la atm√≥sfera como
              resultado de actividades humanas.
            </p>
            <p class="mb-4">
              Estas actividades pueden incluir desde el uso de medios de
              transporte, el consumo energ√©tico en el hogar, la alimentaci√≥n, el
              consumo de bienes y servicios, hasta la generaci√≥n de residuos.
            </p>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up"
            >
              <h3 class="text-xl font-bold mb-3 text-primary">
                ¬øPor qu√© es importante?
              </h3>
              <p>
                La huella de carbono es una herramienta clave para comprender el
                impacto que tienen nuestros h√°bitos cotidianos en el cambio
                clim√°tico. Al reducir nuestras emisiones, contribuimos a limitar
                el aumento de la temperatura global.
              </p>
            </div>
            <div
              class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up"
              style="animation-delay: 0.2s"
            >
              <h3 class="text-xl font-bold mb-3 text-primary">
                ¬øQu√© es PowerGreen?
              </h3>
              <p>
                PowerGreen es una p√°gina web que nace con un prop√≥sito claro:
                que cada persona pueda conocer el impacto que deja en el planeta
                y, sobre todo, que tenga el poder de reducirlo.
              </p>
            </div>
          </div>

          <button
            id="getStartedBtn"
            class="bg-primary hover:bg-secondary text-white font-bold py-3 px-8 rounded-full transition-all transform hover:scale-105 shadow-lg animate-bounce"
          >
            Comienza Ahora
          </button>
        </div>
      </section>

      <!-- Calculadora de Huella de Carbono -->
      <section id="calculator" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Calcula Tu Huella de Carbono
        </h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Transporte</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2"
                  >¬øCu√°ntos kil√≥metros conduces por semana?</label
                >

                <input
                  type="range"
                  min="0"
                  max="500"
                  value="100"
                  class="slider w-full"
                  id="driveDistance"
                />
                <div class="flex justify-between">
                  <span>0 km</span>
                  <span id="drivingValue">100 km</span>
                  <span>500 km</span>
                </div>
              </div>
              <div>
                <label class="block mb-2">¬øCu√°ntos vuelos tomas al a√±o?</label>

                <input
                  type="range"
                  min="0"
                  max="20"
                  value="2"
                  class="slider w-full"
                  id="flightsPerYear"
                />
                <div class="flex justify-between">
                  <span>0</span>
                  <span id="flightsValue">2 vuelos</span>
                  <span>20</span>
                </div>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia usas transporte p√∫blico?</label
                >

                <select
                  id="publicTransport"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">Nunca</option>
                  <option value="1">Raramente (1-2 veces al mes)</option>
                  <option value="2" selected="">
                    Ocasionalmente (1-2 veces por semana)
                  </option>
                  <option value="3">
                    Frecuentemente (3-5 veces por semana)
                  </option>
                  <option value="4">Diariamente</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Energ√≠a en el Hogar</h3>
            <div class="space-y-4">
              <div>
                <div class="flex items-center">
                  <label class="block mb-2"
                    >¬øCu√°l es tu consumo mensual de electricidad (kWh)?</label
                  >
                  <span
                    class="info-tooltip ml-1"
                    data-info="Puedes consultarlo en la p√°gina de tu proveedor de energ√≠a. El consumo promedio en hogares es de 250-300 kWh mensuales."
                  >
                    <svg
                      class="w-4 h-4 inline text-gray-500 dark:text-gray-400"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="1000"
                  value="300"
                  class="slider w-full"
                  id="electricityUsage"
                />
                <div class="flex justify-between">
                  <span>0 kWh</span>
                  <span id="electricityValue">300 kWh</span>
                  <span>1000 kWh</span>
                </div>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øUtilizas fuentes de energ√≠a renovable? (Solar, E√≥lica o
                  Hidr√≥lica)</label
                >

                <select
                  id="renewableEnergy"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">No</option>
                  <option value="1">Parcialmente</option>
                  <option value="2">S√≠, completamente</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Alimentaci√≥n & Consumo</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia consumes productos animales?</label
                >
                <select
                  id="dietType"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="4">Diariamente, varias veces</option>
                  <option value="3" selected>Diariamente, una vez</option>
                  <option value="2">Unas pocas veces por semana</option>
                  <option value="1">Raramente</option>
                  <option value="0">Nunca (vegano/vegetariano)</option>
                </select>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia compras ropa nueva?</label
                >
                <select
                  id="clothingHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="3">Muy frecuentemente (mensualmente)</option>
                  <option value="2" selected>
                    Ocasionalmente (trimestralmente)
                  </option>
                  <option value="1">Raramente (anualmente)</option>
                  <option value="0">Casi nunca / Solo de segunda mano</option>
                </select>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia compras electr√≥nicos nuevos?</label
                >
                <select
                  id="electronicsHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="3">Muy frecuentemente (cada 1-2 a√±os)</option>
                  <option value="2" selected>
                    Ocasionalmente (cada 3-5 a√±os)
                  </option>
                  <option value="1">Raramente (cada 5+ a√±os)</option>
                  <option value="0">Casi nunca / Solo de segunda mano</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Gesti√≥n de Residuos</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2">¬øReciclas?</label>

                <select
                  id="recyclingHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">Nunca</option>
                  <option value="1">A veces</option>
                  <option value="2" selected="">Regularmente</option>
                  <option value="3">Siempre, y hago compost</option>
                </select>
              </div>
            </div>
          </div>

          <button
            id="calculateBtn"
            class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 w-full md:w-auto"
          >
            Calcular Mi Huella
          </button>
        </div>

        <!-- Secci√≥n de Resultados (inicialmente oculta) -->
        <div id="resultsSection" class="mt-8 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-primary">
              Resultados de Tu Huella de Carbono
            </h3>

            <div class="mb-6 text-center">
              <p class="text-lg mb-2">Tu huella de carbono anual estimada:</p>
              <p class="text-4xl font-bold text-primary">
                <span id="totalCarbonFootprint">0</span> toneladas CO‚ÇÇe
              </p>
              <p class="text-sm mt-2 text-gray-600 dark:text-gray-400">
                El promedio es <span id="averageComparison">10</span> toneladas
                CO‚ÇÇe por persona
              </p>
            </div>

            <div class="mb-6">
              <h4 class="font-semibold mb-2">Tu impacto por categor√≠a:</h4>
              <div class="h-64">
                <canvas id="footprintChart"></canvas>
              </div>
            </div>

            <div class="mb-6">
              <h4 class="font-semibold mb-2">√Åreas de mejora:</h4>
              <ul id="improvementAreas" class="list-disc pl-5 space-y-2">
                <!-- Se llenar√° din√°micamente -->
              </ul>
            </div>

            <div class="mt-6 flex flex-wrap justify-center gap-4">
              <button
                id="viewTipsBtn"
                class="bg-accent hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Ver Consejos Personalizados
              </button>
              <button
                id="viewChallengesBtn"
                class="bg-secondary hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Unirse a Retos
              </button>
              <button
                id="saveResultsBtn"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Guardar Resultados
              </button>
            </div>
          </div>
        </div>
      </section>

<!-- Secci√≥n Diario (tarjetas deslizables) -->
        <section id="daily" class="tab-content">
          <div class="max-w-5xl mx-auto">
            <h2 class="text-2xl font-semibold mb-4">Carga diaria</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-4">
              Desliza las tarjetas y registra tu huella para hoy en la categor√≠a que quieras.
            </p>

            <!-- Carrusel -->
            <div id="dailyCarousel" class="pg-carousel no-scrollbar"></div>

            <!-- Tip: mini resumen del d√≠a -->
            <div id="dailySummary" class="mt-6 p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-soft">
              <div class="flex items-center justify-between">
                <span class="font-medium">Total de hoy</span>
                <span id="dailyTotal" class="text-lg font-semibold text-primary">0 kg CO‚ÇÇe</span>
              </div>
              <p id="dailyHint" class="text-sm text-gray-600 dark:text-gray-400 mt-1">A√∫n no registraste nada hoy.</p>
            </div>
          </div>
        </section>

        <!-- Modal de carga diaria -->
        <div id="dailyModal" class="fixed inset-0 hidden items-center justify-center z-50">
          <div class="absolute inset-0 pg-modal-backdrop"></div>
          <div class="relative bg-white dark:bg-gray-900 rounded-2xl shadow-soft w-full max-w-md mx-4 p-6">
            <button id="dailyModalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            <div class="flex items-center gap-3 mb-4">
              <div id="dailyModalIcon" class="pg-card-icon">üå±</div>
              <div>
                <h3 id="dailyModalTitle" class="text-xl font-semibold">Registrar</h3>
                <p id="dailyModalDesc" class="text-sm text-gray-600 dark:text-gray-400">Carga del d√≠a para esta categor√≠a.</p>
              </div>
            </div>
            <div class="space-y-4">
              <label class="block text-sm font-medium">Valor de hoy</label>
              <input id="dailyModalInput" type="number" min="0" step="0.01" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-800" />
              <p id="dailyModalUnit" class="text-sm text-gray-600 dark:text-gray-400">unidad</p>
              <button id="dailyModalSave" class="w-full py-3 rounded-2xl bg-primary text-white font-semibold hover:opacity-90">Guardar</button>
            </div>
          </div>
        </div>


        


      <!-- Secci√≥n de Consejos -->
      <section id="tips" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Consejos Personalizados
        </h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <div id="tipFilters" class="mb-6">
            <h3 class="text-lg font-semibold mb-3">Filtrar por categor√≠a:</h3>
            <div class="flex flex-wrap gap-2">
              <button
                class="tip-filter active px-4 py-2 rounded-full bg-primary text-white"
                data-category="all"
              >
                Todos
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="transport"
              >
                Transporte
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="energy"
              >
                Energ√≠a
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="food"
              >
                Alimentaci√≥n
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="consumption"
              >
                Consumo
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="waste"
              >
                Residuos
              </button>
            </div>
          </div>

          <div
            id="tipsList"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- Consejos de Transporte -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">Combina Recados</h3>
              <p>
                Planifica tus viajes para combinar m√∫ltiples recados en un solo
                trayecto. Esto puede reducir tu distancia de conducci√≥n hasta un
                30%.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de transporte en 10-15%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">
                Mant√©n la Presi√≥n Correcta de los Neum√°ticos
              </h3>
              <p>
                Mantener tus neum√°ticos correctamente inflados puede mejorar la
                eficiencia de combustible hasta un 3%. Revisa la presi√≥n
                mensualmente.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir consumo de combustible en 2-3%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">Usa Transporte P√∫blico</h3>
              <p>
                Tomar transporte p√∫blico solo una vez a la semana en lugar de
                conducir puede reducir significativamente tu huella de carbono.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 795 kg de CO‚ÇÇ anuales
              </p>
            </div>

            <!-- Consejos de Energ√≠a -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">Cambia a Bombillas LED</h3>
              <p>
                Las luces LED usan hasta 85% menos energ√≠a que las bombillas
                tradicionales y duran 25 veces m√°s.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir uso de energ√≠a en iluminaci√≥n en
                75-80%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">
                Desconecta Electr√≥nicos
              </h3>
              <p>
                Muchos dispositivos consumen energ√≠a incluso cuando est√°n
                apagados. Desconecta cargadores y electr√≥nicos cuando no los
                uses.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir consumo en espera en 5-10%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">Ajusta el Termostato</h3>
              <p>
                Baja tu termostato 1-2¬∞C en invierno y s√∫belo 1-2¬∞C en verano
                para ahorrar energ√≠a.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir energ√≠a de calefacci√≥n/refrigeraci√≥n
                en 5-15%
              </p>
            </div>

            <!-- Consejos de Alimentaci√≥n -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">Lunes Sin Carne</h3>
              <p>
                No comer carne solo un d√≠a a la semana puede marcar una gran
                diferencia en tu huella de carbono.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 400 kg de CO‚ÇÇ anuales
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">
                Compra Local y de Temporada
              </h3>
              <p>
                Los alimentos locales y de temporada requieren menos transporte
                y a menudo menos energ√≠a para su producci√≥n.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir huella de carbono de alimentos en
                10-20%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">
                Reduce el Desperdicio de Alimentos
              </h3>
              <p>
                Planifica comidas, almacena alimentos correctamente y usa sobras
                para reducir la cantidad de comida que tiras.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 300 kg de CO‚ÇÇ anuales
              </p>
            </div>

            <!-- Consejos de Consumo -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">
                Compra Calidad, Compra Menos
              </h3>
              <p>
                Invierte en art√≠culos duraderos y de alta calidad que durar√°n
                m√°s, reduciendo la necesidad de reemplazos frecuentes.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir huella de bienes de consumo en 20%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">Compra de Segunda Mano</h3>
              <p>
                Considera comprar art√≠culos usados. El costo ambiental de
                producci√≥n ya ha sido pagado.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de manufactura en 100%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">Repara, No Reemplaces</h3>
              <p>
                Aprende habilidades b√°sicas de reparaci√≥n o encuentra servicios
                locales para reparar electr√≥nicos, ropa y otros art√≠culos.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Extender vida √∫til del producto 2-3 veces
              </p>
            </div>

            <!-- Consejos de Residuos -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">Comienza a Compostar</h3>
              <p>
                Compostar residuos org√°nicos reduce emisiones de metano de
                vertederos y crea tierra valiosa para plantas.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de residuos org√°nicos en
                50%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">
                Usa Contenedores Reutilizables
              </h3>
              <p>
                Lleva tus propios contenedores para comida para llevar, sobras y
                compras para reducir residuos de empaques desechables.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Eliminar 100+ piezas de empaques desechables
                al a√±o
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">Reciclaje Adecuado</h3>
              <p>
                Aprende las pautas de reciclaje locales para asegurarte de que
                tus art√≠culos realmente se reciclen correctamente.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Aumentar efectividad del reciclaje en 30%
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Secci√≥n de Retos -->
      <section id="challenges" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Retos de Sostenibilidad
        </h2>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
          <h3 class="text-xl font-semibold mb-4">Retos Activos</h3>
          <div id="activeChallengesTodo" class="space-y-4">
            <p class="text-gray-500 dark:text-gray-400 text-center py-4">
              A√∫n no te has unido a ning√∫n reto.
            </p>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-semibold mb-4">Retos Disponibles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Semana Sin Carne</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >7 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Intenta no comer carne durante una semana para reducir
                significativamente tu huella de carbono.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="meatless-week"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">D√≠as Sin Auto</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >5 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Comprom√©tete a usar solo transporte p√∫blico, bicicleta o caminar
                durante 5 d√≠as.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óè</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="no-car-days"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">
                  Fin de Semana Cero Residuos
                </h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >2 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Intenta no producir residuos para vertedero durante un fin de
                semana completo. Recicla, composta o evita residuos por
                completo.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="zero-waste-weekend"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Mes de Ahorro de Energ√≠a</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >30 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Reduce tu consumo de energ√≠a en 20% durante un mes haciendo
                cambios simples en tus h√°bitos diarios.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="energy-saver-month"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Mes Sin Compras Nuevas</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >30 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Comprom√©tete a no comprar art√≠culos no esenciales nuevos durante
                un mes. Pide prestado, repara o prescinde.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="no-new-stuff-month"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Ahorrador de Agua</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >14 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Reduce tu consumo de agua en 25% durante dos semanas mediante
                simples cambios diarios.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="water-saver"
              >
                Unirse al Reto
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Secci√≥n de Progreso -->
      <section id="progress" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">Tu Progreso</h2>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
          <h3 class="text-xl font-semibold mb-4">
            Huella de Carbono en el Tiempo
          </h3>
          <div class="h-64">
            <canvas id="progressChart"></canvas>
          </div>
          <p
            id="noProgressData"
            class="text-center py-4 text-gray-500 dark:text-gray-400"
          >
            Registra tu huella en el tiempo calcul√°ndola regularmente.
          </p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
          <h3 class="text-xl font-semibold mb-4">Historial de Retos</h3>
          <div id="challengeHistory" class="space-y-4">
            <p class="text-center py-4 text-gray-500 dark:text-gray-400">
              A√∫n no has completado ning√∫n reto.
            </p>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-semibold mb-4">Tu Impacto</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-5 text-center"
            >
              <div class="text-4xl font-bold text-primary mb-2">0</div>
              <p class="text-gray-600 dark:text-gray-400">
                Toneladas de CO‚ÇÇ ahorradas
              </p>
            </div>
            <div
              class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-5 text-center"
            >
              <div class="text-4xl font-bold text-primary mb-2">0</div>
              <p class="text-gray-600 dark:text-gray-400">Retos completados</p>
            </div>
            <div
              class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-5 text-center"
            >
              <div class="text-4xl font-bold text-primary mb-2">0</div>
              <p class="text-gray-600 dark:text-gray-400">
                D√≠as de seguimiento
              </p>
            </div>
          </div>
        </div>
      </section>
      
    </main>

    <footer class="bg-dark text-white py-6 mt-10">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-4 md:mb-0">
            <h2 class="text-xl font-bold text-primary mb-2">PowerGreen</h2>
            <p class="text-sm text-gray-400">
              Haciendo un futuro sostenible accesible para todos.
            </p>
          </div>
          <div class="flex space-x-4">
            <a
              href="#"
              id="aboutLink"
              class="hover:text-primary text-green-600 transition-colors duration-300"
              >Acerca de</a
            >
            <a
              href="#"
              target="_blank"
              class="hover:text-primary text-green-600 transition-colors duration-300"
              >Privacidad</a
            >
            <a
              href="#"
              id="contactLink"
              class="hover:text-primary text-green-600 transition-colors duration-300"
              >Contacto</a
            >
          </div>
        </div>
        <div class="text-center mt-6 text-sm text-gray-400">
          <p>¬© 2025 PowerGreen. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const globalLoader = document.getElementById("globalLoader");
        // Navegaci√≥n y gesti√≥n de pesta√±as
        const authSection = document.getElementById("auth-section");
        const mainContent = document.querySelector(
          "main > section:not(#auth-section)"
        );
        const header = document.querySelector("header");
        const footer = document.querySelector("footer");
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const menuToggle = document.getElementById("menuToggle");
        const mobileMenu = document.getElementById("mobileMenu");
        const getStartedBtn = document.getElementById("getStartedBtn");
        const welcomeSection = document.getElementById("welcome");
        const calculateBtn = document.getElementById("calculateBtn");
        const resultsSection = document.getElementById("resultsSection");
        const aboutLink = document.getElementById("aboutLink");

        const auth = window.firebaseAuth;
        globalLoader.style.display = "flex";


        

// ---- Esperar a que Firebase est√© listo y reci√©n ah√≠ enganchar onAuthStateChanged ----
function waitForFirebaseReady() {
  return new Promise(function (resolve, reject) {
    var t0 = Date.now();
    (function check() {
      if (window.firebaseAuth && window.firebaseAuth.firestore && window.firebaseAuth.firestore.api) return resolve();
      if (Date.now() - t0 > 7000) return reject(new Error("Firebase no inicializ√≥ a tiempo"));
      setTimeout(check, 40);
    })();
  });
}

// Variables que vamos a asignar cuando Firebase est√© listo
let DB, FAPI, doc, setDoc, getDoc;

// REGISTRO del onAuthStateChanged despu√©s de que Firebase exista
waitForFirebaseReady().then(function () {
  FAPI = window.firebaseAuth.firestore.api;
  DB   = window.firebaseAuth.firestore.db;
  ({ doc, setDoc, getDoc } = FAPI);

  window.firebaseAuth.onAuthStateChanged(function (user) {
    // Fade-out del loader/splash (dise√±o se mantiene)
    globalLoader.style.opacity = "0";
    setTimeout(function () {
      globalLoader.style.display = "none";

      if (user) {
        // UI logueado (id√©ntico a lo que ya ten√≠as)
        authSection.style.display = "none";
        mainContent.style.display = "block";
        header.style.display = "flex";
        footer.style.display = "block";
        mobileMenu.classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");

        // Asegurar doc de usuario + decidir pantalla SIN async/await
        ensureUserDoc(user.uid)
          .then(function () {
            return getDoc(doc(DB, "users", user.uid));
          })
          .then(function (userSnap) {
            var completed = userSnap.exists() && userSnap.data() && userSnap.data().initialSurvey && userSnap.data().initialSurvey.completedAt;
            // si ya pegaste renderDailyCards(), pod√©s llamarlo aqu√≠ (no cambia dise√±o)
            if (typeof renderDailyCards === "function") renderDailyCards();
            showTab(completed ? "daily" : "calculator");

            // si ten√©s funciones de progreso, refrescarlas aqu√≠
            if (typeof updateProgressChart === "function") updateProgressChart();
            if (typeof updateProgressStats === "function") updateProgressStats();
          })
          .catch(function (e) {
            console.error(e);
            showTab("calculator");
          });

      } else {
        // UI no logueado (id√©ntico a lo que ya ten√≠as)
        authSection.style.display = "block";
        mainContent.style.display = "none";
        header.style.display = "none";
        footer.style.display = "none";
        document.getElementById("logoutBtn").classList.add("hidden");
      }
    }, 500);
  });
}).catch(function (e) {
  console.error(e);
});


        // Inicialmente ocultar todo excepto auth
        mainContent.style.display = "none";
        header.style.display = "none";
        footer.style.display = "none";
        welcomeSection.classList.add("hidden");

        // Maneja el clic en "Acerca de"
        aboutLink.addEventListener("click", function (e) {
          e.preventDefault();

          // Oculta todas las pesta√±as
          tabContents.forEach((tab) => {
            tab.classList.remove("active");
          });

          // Muestra solo la secci√≥n Welcome
          welcomeSection.classList.remove("hidden");

          // Desmarca cualquier bot√≥n de pesta√±a activo
          tabButtons.forEach((button) => {
            button.classList.remove("text-white", "font-bold");
            button.classList.add("text-gray-200");
          });
        });

        // Login
        document
          .getElementById("loginBtn")
          .addEventListener("click", async () => {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            try {
              await window.firebaseAuth.signInWithEmailAndPassword(
                email,
                password
              );
              authMessage.textContent = "Inicio de sesi√≥n exitoso!";
              authMessage.className = "mt-4 text-center text-green-500";
              authMessage.classList.remove("hidden");
            } catch (error) {
              let message = "Error al iniciar sesi√≥n";
              if (error.code === "auth/invalid-email")
                message = "Email inv√°lido";
              if (error.code === "auth/user-not-found")
                message = "Usuario no encontrado";
              if (error.code === "auth/wrong-password")
                message = "Contrase√±a incorrecta";

              authMessage.textContent = message;
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
            }
          });

        // Logout
        document
          .getElementById("logoutBtn")
          .addEventListener("click", async () => {
            try {
              await window.firebaseAuth.signOut();
            } catch (error) {
              console.error("Error al cerrar sesi√≥n:", error);
            }
            // Oculta todas las pesta√±as
            tabContents.forEach((tab) => {
              tab.classList.remove("active");
            });
          });

        // Registro
        document
          .getElementById("registerBtn")
          .addEventListener("click", async () => {
            //const name = document.getElementById('registerName').value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;
            const authMessage = document.getElementById("authMessage");

            if (password.length < 6) {
              authMessage.textContent =
                "La contrase√±a debe tener al menos 6 caracteres";
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
              return;
            }

            try {
              await window.firebaseAuth.createUserWithEmailAndPassword(
                email,
                password
              );
              authMessage.textContent = "Registro exitoso!";
              authMessage.className = "mt-4 text-center text-green-500";
              authMessage.classList.remove("hidden");

              // Mostrar formulario de login despu√©s de registro
              document.getElementById("registerForm").classList.add("hidden");
              document.getElementById("loginForm").classList.remove("hidden");
            } catch (error) {
              let message = "Error al registrarse";
              if (error.code === "auth/email-already-in-use")
                message = "El email ya est√° en uso";
              if (error.code === "auth/invalid-email")
                message = "Email inv√°lido";
              if (error.code === "auth/weak-password")
                message = "Contrase√±a d√©bil";

              authMessage.textContent = message;
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
            }
          });

        // Alternar entre login y registro
        document
          .getElementById("showRegister")
          .addEventListener("click", () => {
            document.getElementById("loginForm").classList.add("hidden");
            document.getElementById("registerForm").classList.remove("hidden");
            document.getElementById("authMessage").classList.add("hidden");
          });

        document.getElementById("showLogin").addEventListener("click", () => {
          document.getElementById("registerForm").classList.add("hidden");
          document.getElementById("loginForm").classList.remove("hidden");
          document.getElementById("authMessage").classList.add("hidden");
        });
        // Valores de entrada de rango
        const driveDistance = document.getElementById("driveDistance");
        const drivingValue = document.getElementById("drivingValue");
        const flightsPerYear = document.getElementById("flightsPerYear");
        const flightsValue = document.getElementById("flightsValue");
        const electricityUsage = document.getElementById("electricityUsage");
        const electricityValue = document.getElementById("electricityValue");

        // Filtrado de consejos
        const tipFilters = document.querySelectorAll(".tip-filter");
        const tipCards = document.querySelectorAll(".tip-card");

        // Botones de navegaci√≥n de resultados
        const viewTipsBtn = document.getElementById("viewTipsBtn");
        const viewChallengesBtn = document.getElementById("viewChallengesBtn");
        const saveResultsBtn = document.getElementById("saveResultsBtn");

        // Botones de retos
        const joinChallengeButtons = document.querySelectorAll(
          ".join-challenge-btn"
        );

        // Alternar men√∫ m√≥vil
        menuToggle.addEventListener("click", function () {
          mobileMenu.classList.toggle("hidden");
        });

        // Navegaci√≥n por pesta√±as
        function showTab(tabId) {
          welcomeSection.classList.add("hidden");
          tabContents.forEach((tab) => {
            tab.classList.remove("active");
          });
          tabButtons.forEach((button) => {
            button.classList.remove("text-white", "font-bold");
            button.classList.add("text-gray-200");
          });

          const targetTab = document.getElementById(tabId);
          const targetButton = document.querySelector(`[data-tab="${tabId}"]`);

          if (targetTab) {
            targetTab.classList.add("active");
            // Ocultar secci√≥n de bienvenida cuando se muestra cualquier pesta√±a
            welcomeSection.classList.add("hidden");
          }

          if (targetButton) {
            targetButton.classList.add("text-white", "font-bold");
            targetButton.classList.remove("text-gray-200");
          }

          // Cerrar men√∫ m√≥vil despu√©s de seleccionar en m√≥vil
          if (window.innerWidth < 768) {
            mobileMenu.classList.add("hidden");
          }
        }

        tabButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");
            showTab(tabId);
          });
        });

        // Bot√≥n Comenzar
        getStartedBtn.addEventListener("click", function () {
          welcomeSection.classList.add("hidden");
          showTab("calculator");
        });

        // Mostrar valores de controles deslizantes
        driveDistance.addEventListener("input", function () {
          drivingValue.textContent = `${this.value} km`;
        });

        flightsPerYear.addEventListener("input", function () {
          flightsValue.textContent = `${this.value} vuelos`;
        });

        electricityUsage.addEventListener("input", function () {
          electricityValue.textContent = `${this.value} kWh`;
        });

        // Filtrar consejos
        tipFilters.forEach((filter) => {
          filter.addEventListener("click", function () {
            const category = this.getAttribute("data-category");

            // Actualizar bot√≥n de filtro activo
            tipFilters.forEach((btn) => {
              btn.classList.remove("active", "bg-primary", "text-white");
              btn.classList.add(
                "bg-gray-200",
                "dark:bg-gray-700",
                "text-gray-800",
                "dark:text-white"
              );
            });
            this.classList.add("active", "bg-primary", "text-white");
            this.classList.remove(
              "bg-gray-200",
              "dark:bg-gray-700",
              "text-gray-800",
              "dark:text-white"
            );

            // Filtrar tarjetas de consejos
            tipCards.forEach((card) => {
              if (
                category === "all" ||
                card.getAttribute("data-category") === category
              ) {
                card.style.display = "block";
              } else {
                card.style.display = "none";
              }
            });
          });
        });

        // Calcular huella de carbono
        calculateBtn.addEventListener("click", async function () {
          // Algoritmo simple de c√°lculo para demostraci√≥n
          const driving = parseInt(driveDistance.value) * 0.0002; // toneladas CO2 por km
          const flights = parseInt(flightsPerYear.value) * 0.5; // toneladas CO2 por vuelo (promedio)
          const publicTransport =
            0.2 -
            parseInt(document.getElementById("publicTransport").value) * 0.05; // basado en frecuencia de uso
          const electricity = parseInt(electricityUsage.value) * 0.0005; // toneladas CO2 por kWh
          const renewableEnergy =
            parseInt(document.getElementById("renewableEnergy").value) * 0.3; // reducci√≥n basada en uso de renovables
          const dietImpact =
            parseInt(document.getElementById("dietType").value) * 0.5; // basado en tipo de dieta
          const clothingImpact =
            parseInt(document.getElementById("clothingHabits").value) * 0.2;
          const electronicsImpact =
            parseInt(document.getElementById("electronicsHabits").value) * 0.3;
          const recyclingImpact =
            0.5 -
            parseInt(document.getElementById("recyclingHabits").value) * 0.15; // basado en h√°bitos de reciclaje

          // Calcular total y redondear a 1 decimal
          const transportTotal = driving + flights + publicTransport;
          const energyTotal = electricity - renewableEnergy;
          const foodTotal = dietImpact;
          const consumptionTotal = clothingImpact + electronicsImpact;
          const wasteTotal = recyclingImpact;

          const total =
            Math.round(
              (transportTotal +
                energyTotal +
                foodTotal +
                consumptionTotal +
                wasteTotal) *
                10
            ) / 10;

          // Mostrar resultados
          document.getElementById("totalCarbonFootprint").textContent = total;
          resultsSection.classList.remove("hidden");

          // Crear o actualizar gr√°fico
          createFootprintChart([
            transportTotal,
            energyTotal,
            foodTotal,
            clothingImpact,
            electronicsImpact,
            wasteTotal,
          ]);

          // Generar √°reas de mejora
          generateImprovementAreas({
            transport: transportTotal,
            energy: energyTotal,
            food: foodTotal,
            consumption: consumptionTotal,
            waste: wasteTotal,
          });

          // Desplazarse a resultados
          resultsSection.scrollIntoView({ behavior: "smooth" });

          // Guardar datos para seguimiento de progreso
          saveFootprintData(total);
          updateProgressChart();
          // Guardar resultados en Firestore (solo si el usuario est√° autenticado)
          const user = window.firebaseAuth.auth.currentUser;
          if (user) {
            const footprintData = {
              total: total,
              categories: {
                transport: transportTotal,
                energy: energyTotal,
                food: foodTotal,
                clothing: clothingImpact,
                electronics: electronicsImpact,
                waste: wasteTotal,
              },
              details: {
                driving: parseInt(driveDistance.value),
                flights: parseInt(flightsPerYear.value),
                publicTransport:
                  document.getElementById("publicTransport").value,
                electricity: parseInt(electricityUsage.value),
                renewableEnergy:
                  document.getElementById("renewableEnergy").value,
                dietType: document.getElementById("dietType").value,
                clothingHabits: document.getElementById("clothingHabits").value,
                electronicsHabits:
                  document.getElementById("electronicsHabits").value,
                recyclingHabits:
                  document.getElementById("recyclingHabits").value,
              },
              date: new Date().toISOString().split("T")[0], // Fecha en formato YYYY-MM-DD
              timestamp: new Date(),
            };

            // Marca la encuesta inicial como completada (1 sola vez)
            try {
              const answersPayload = footprintData?.inputs || null; // si quer√©s guardar respuestas bases
              await setInitialSurveyDone(user.uid, answersPayload);
            } catch (e) {
              console.warn("No se pudo marcar initialSurvey:", e);
            }


            try {
              // Mostrar estado de guardado
              saveResultsBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Guardando...';
              saveResultsBtn.disabled = true;

              // Guardar en Firestore
              const saved = await window.firebaseAuth.firestore.saveFootprint(
                user.uid,
                footprintData
              );

              if (saved) {
                saveResultsBtn.textContent = "¬°Resultados Guardados!";
                setTimeout(() => {
                  saveResultsBtn.textContent = "Guardar Resultados";
                  saveResultsBtn.disabled = false;
                }, 2000);
              } else {
                saveResultsBtn.textContent = "Error al guardar";
                saveResultsBtn.disabled = false;
              }
            } catch (error) {
              console.error("Error al guardar huella:", error);
              saveResultsBtn.textContent = "Error al guardar";
              saveResultsBtn.disabled = false;
            }
          } else {
            saveResultsBtn.textContent = "Inicia sesi√≥n para guardar";
            setTimeout(() => {
              saveResultsBtn.textContent = "Guardar Resultados";
            }, 2000);
          }
        });

        // Creaci√≥n de gr√°fico de huella
        let footprintChart;
        function createFootprintChart(data) {
          const ctx = document
            .getElementById("footprintChart")
            .getContext("2d");

          if (footprintChart) {
            footprintChart.destroy();
          }

          footprintChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: [
                "Transporte",
                "Energ√≠a en el Hogar",
                "Alimentaci√≥n",
                "Ropa",
                "Electr√≥nicos",
                "Residuos",
              ],
              datasets: [
                {
                  data: data,
                  backgroundColor: [
                    "#3498DB", // Azul - Transporte
                    "#F1C40F", // Amarillo - Energ√≠a
                    "#2ECC71", // Verde - Alimentaci√≥n
                    "#9B59B6", // Morado - Ropa
                    "#FFA500", // Naranja - Electr√≥nicos
                    "#E74C3C", // Rojo - Residuos
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    color: document.documentElement.classList.contains("dark")
                      ? "#ECF0F1"
                      : "#2C3E50",
                  },
                },
              },
            },
          });
        }

        // Generar √°reas de mejora basadas en resultados
        function generateImprovementAreas(data) {
          const improvementList = document.getElementById("improvementAreas");
          improvementList.innerHTML = "";

          // Ordenar categor√≠as por impacto
          const categories = Object.entries(data).sort((a, b) => b[1] - a[1]);

          // Generar sugerencias para las 3 principales categor√≠as
          for (let i = 0; i < Math.min(3, categories.length); i++) {
            const [category, impact] = categories[i];
            const suggestion = getImprovementSuggestion(category);
            const li = document.createElement("li");
            li.className = "text-gray-700 dark:text-gray-300";
            li.innerHTML = `<strong>${formatCategoryName(
              category
            )}:</strong> ${suggestion}`;
            improvementList.appendChild(li);
          }
        }

        // Formatear nombre de categor√≠a para mostrar
        function formatCategoryName(category) {
          const names = {
            transport: "Transporte",
            energy: "Energ√≠a",
            food: "Alimentaci√≥n",
            consumption: "Consumo",
            waste: "Residuos",
          };
          return (
            names[category] ||
            category.charAt(0).toUpperCase() + category.slice(1)
          );
        }

        // Obtener sugerencia de mejora basada en categor√≠a
        function getImprovementSuggestion(category) {
          const suggestions = {
            transport:
              "Intenta usar m√°s el transporte p√∫blico o compartir coche para reducir emisiones.",
            energy:
              "Considera cambiar a electrodom√©sticos eficientes y iluminaci√≥n LED.",
            food: "Reducir el consumo de carne, especialmente carne roja, puede disminuir significativamente tu huella.",
            consumption:
              "Enf√≥cate en comprar menos art√≠culos de mayor calidad que duren m√°s.",
            waste:
              "Mejora tus h√°bitos de reciclaje y considera compostar residuos org√°nicos.",
          };

          return (
            suggestions[category] ||
            "Busca formas de reducir el consumo en esta √°rea."
          );
        }

        // Guardar datos de huella para seguimiento de progreso
        function saveFootprintData(total) {
          // En una aplicaci√≥n real, esto usar√≠a una base de datos o API
          // Como no podemos usar localStorage, usaremos almacenamiento temporal en memoria
          if (!window.footprintHistory) {
            window.footprintHistory = [];
          }

          window.footprintHistory.push({
            date: new Date(),
            value: total,
          });

          // Si tenemos datos, ocultar el mensaje "sin datos"
          if (window.footprintHistory.length > 0) {
            document.getElementById("noProgressData").style.display = "none";
          }
        }

        // Actualizar gr√°fico de progreso con datos hist√≥ricos
        async function updateProgressChart() {
          const user = window.firebaseAuth.auth.currentUser;
          if (!user) return;

          try {
            const history =
              await window.firebaseAuth.firestore.getFootprintHistory(user.uid);

            if (history.length === 0) {
              document.getElementById("noProgressData").style.display = "block";
              return;
            }

            document.getElementById("noProgressData").style.display = "none";

            // Preparar datos para la gr√°fica
            const labels = history
              .map((entry) => {
                const date = new Date(entry.date);
                return `${date.getDate()}/${date.getMonth() + 1}`; // Formato DD/MM
              })
              .reverse();

            const values = history.map((entry) => entry.total).reverse();

            // Crear o actualizar gr√°fico
            const ctx = document
              .getElementById("progressChart")
              .getContext("2d");

            if (window.progressChart) {
              window.progressChart.destroy();
            }

            window.progressChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Huella de Carbono (toneladas CO‚ÇÇe)",
                    data: values,
                    fill: false,
                    borderColor: "#2ECC71",
                    tension: 0.1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Toneladas CO‚ÇÇe",
                      color: document.documentElement.classList.contains("dark")
                        ? "#ECF0F1"
                        : "#2C3E50",
                    },
                    ticks: {
                      color: document.documentElement.classList.contains("dark")
                        ? "#ECF0F1"
                        : "#2C3E50",
                    },
                    grid: {
                      color: document.documentElement.classList.contains("dark")
                        ? "rgba(255, 255, 255, 0.1)"
                        : "rgba(0, 0, 0, 0.1)",
                    },
                  },
                  x: {
                    ticks: {
                      color: document.documentElement.classList.contains("dark")
                        ? "#ECF0F1"
                        : "#2C3E50",
                    },
                    grid: {
                      color: document.documentElement.classList.contains("dark")
                        ? "rgba(255, 255, 255, 0.1)"
                        : "rgba(0, 0, 0, 0.1)",
                    },
                  },
                },
                plugins: {
                  legend: {
                    labels: {
                      color: document.documentElement.classList.contains("dark")
                        ? "#ECF0F1"
                        : "#2C3E50",
                    },
                  },
                },
              },
            });
          } catch (error) {
            console.error("Error al cargar el historial:", error);
          }
        }

        // Navegaci√≥n de resultados
        viewTipsBtn.addEventListener("click", function () {
          showTab("tips");
        });

        viewChallengesBtn.addEventListener("click", function () {
          showTab("challenges");
        });

        saveResultsBtn.addEventListener("click", function () {
          // Ya guardado en la funci√≥n de c√°lculo
          // Solo mostrar confirmaci√≥n
          const saveBtn = document.getElementById("saveResultsBtn");
          const originalText = saveBtn.textContent;
          saveBtn.textContent = "¬°Resultados Guardados!";
          saveBtn.disabled = true;

          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }, 2000);
        });

        async function updateProgressStats() {
          const user = window.firebaseAuth.auth.currentUser;
          if (!user) return;

          try {
            const history =
              await window.firebaseAuth.firestore.getFootprintHistory(user.uid);

            if (history.length > 0) {
              // Calcular total ahorrado (comparando con el promedio)
              const average = 10; // 10 toneladas promedio
              const saved = history.reduce(
                (acc, curr) => acc + (average - curr.total),
                0
              );

              // Actualizar los contadores
              document.querySelector(
                "#progress .grid.grid-cols-1 div:nth-child(1) div"
              ).textContent = Math.max(0, saved.toFixed(1));
              document.querySelector(
                "#progress .grid.grid-cols-1 div:nth-child(2) div"
              ).textContent = document.getElementById(
                "activeChallengesTodo"
              ).children.length;
              document.querySelector(
                "#progress .grid.grid-cols-1 div:nth-child(3) div"
              ).textContent = history.length;
            }
          } catch (error) {
            console.error("Error al actualizar estad√≠sticas:", error);
          }
        }

        // Funcionalidad para unirse a retos
        joinChallengeButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const challengeId = this.getAttribute("data-id");
            const challengeCard = this.closest(".challenge-card");
            const challengeTitle =
              challengeCard.querySelector("h4").textContent;

            // Agregar a retos activos
            const activeChallengesTodo = document.getElementById(
              "activeChallengesTodo"
            );

            // Si hay un mensaje "sin retos", limpiarlo
            if (activeChallengesTodo.querySelector("p")) {
              activeChallengesTodo.innerHTML = "";
            }

            // Crear nuevo elemento de reto activo
            const activeChallenge = document.createElement("div");
            activeChallenge.className =
              "bg-white dark:bg-gray-700 rounded-lg shadow-md p-4 fade-in";
            activeChallenge.setAttribute("data-id", challengeId);

            // Agregar contenido del reto
            activeChallenge.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold">${challengeTitle}</h4>
                            <span class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-100 px-2 py-1 rounded-full text-xs">En Progreso</span>
                        </div>
                        <div class="mb-3">
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span>0%</span>
                                <span>Progreso</span>
                                <span>100%</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <button class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded transition-colors duration-300 abandon-btn">
                                Abandonar
                            </button>
                            <button class="bg-green-500 hover:bg-green-600 text-white text-sm py-1 px-3 rounded transition-colors duration-300 progress-btn">
                                Actualizar Progreso
                            </button>
                        </div>
                    `;

            activeChallengesTodo.appendChild(activeChallenge);

            // Deshabilitar bot√≥n de unirse en la tarjeta de reto
            this.textContent = "Unido";
            this.disabled = true;
            this.classList.add("bg-gray-500");
            this.classList.remove("bg-primary", "hover:bg-secondary");

            // Agregar event listeners a los nuevos botones
            activeChallenge
              .querySelector(".abandon-btn")
              .addEventListener("click", function () {
                // Eliminar de retos activos
                activeChallenge.remove();

                // Rehabilitar bot√≥n de unirse
                const joinButton = document.querySelector(
                  `.join-challenge-btn[data-id="${challengeId}"]`
                );
                if (joinButton) {
                  joinButton.textContent = "Unirse al Reto";
                  joinButton.disabled = false;
                  joinButton.classList.remove("bg-gray-500");
                  joinButton.classList.add("bg-primary", "hover:bg-secondary");
                }

                // Si no hay retos activos, mostrar mensaje "sin retos"
                if (activeChallengesTodo.children.length === 0) {
                  activeChallengesTodo.innerHTML =
                    '<p class="text-gray-500 dark:text-gray-400 text-center py-4">A√∫n no te has unido a ning√∫n reto.</p>';
                }
              });

            activeChallenge
              .querySelector(".progress-btn")
              .addEventListener("click", function () {
                // Simular actualizaci√≥n de progreso
                const progressBar =
                  activeChallenge.querySelector(".progress-bar");
                const currentWidth = parseInt(progressBar.style.width) || 0;
                const newWidth = Math.min(currentWidth + 20, 100);
                progressBar.style.width = `${newWidth}%`;

                // Si se complet√≥, mover a retos completados
                if (newWidth >= 100) {
                  // Mover a historial de retos
                  const challengeHistory =
                    document.getElementById("challengeHistory");

                  // Si hay un mensaje "sin retos completados", limpiarlo
                  if (challengeHistory.querySelector("p")) {
                    challengeHistory.innerHTML = "";
                  }

                  // Crear elemento de reto completado
                  const completedChallenge = document.createElement("div");
                  completedChallenge.className =
                    "bg-white dark:bg-gray-700 rounded-lg shadow-md p-4 fade-in";
                  completedChallenge.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <h4 class="font-semibold">${challengeTitle}</h4>
                                    <span class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs">Completado</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Completado el ${new Date().toLocaleDateString()}</p>
                            `;

                  challengeHistory.appendChild(completedChallenge);

                  // Eliminar de retos activos
                  activeChallenge.remove();

                  // Si no hay retos activos, mostrar mensaje "sin retos"
                  if (activeChallengesTodo.children.length === 0) {
                    activeChallengesTodo.innerHTML =
                      '<p class="text-gray-500 dark:text-gray-400 text-center py-4">A√∫n no te has unido a ning√∫n reto.</p>';
                  }
                }
              });
          });
        });

        // Inicializar mostrando primero la secci√≥n de bienvenida
        tabContents.forEach((tab) => {
          tab.classList.remove("active");
        });

        // Inicializar gr√°fico de progreso si existen datos
        updateProgressChart();
        updateProgressStats();
        // Contact Modal functionality
        const contactModal = document.getElementById("contactModal");
        const contactLink = document.getElementById("contactLink");
        const closeContactModal = document.getElementById("closeContactModal");
        const copyEmailBtn = document.getElementById("copyEmailBtn");

        if (contactLink) {
          contactLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (contactModal) contactModal.classList.remove("hidden");
          });
        }

        if (closeContactModal) {
          closeContactModal.addEventListener("click", () => {
            if (contactModal) contactModal.classList.add("hidden");
          });
        }

        if (copyEmailBtn) {
          copyEmailBtn.addEventListener("click", () => {
            navigator.clipboard.writeText("powergreen_app@gmail.com");
            copyEmailBtn.textContent = "¬°Copiado!";
            setTimeout(() => {
              copyEmailBtn.textContent = "Copiar Email";
            }, 2000);
          });
        }

        // Cerrar modal al hacer click fuera del contenido
        if (contactModal) {
          contactModal.addEventListener("click", (e) => {
            if (e.target === contactModal) {
              contactModal.classList.add("hidden");
            }
          });
        }
        // Al final de tu event listener DOMContentLoaded, a√±ade:
        document
          .getElementById("testFirestoreBtn")
          .addEventListener("click", async () => {
            const result = await window.firebaseAuth.firestore.testConnection();
            if (result) {
              alert(
                "¬°Conexi√≥n con Firestore exitosa! Revisa tu base de datos en Firebase Console."
              );
            } else {
              alert(
                "Error al conectar con Firestore. Revisa la consola para m√°s detalles."
              );
            }
          });
      });
    </script>

    <script>
  // ... (tus variables ya existentes)

  // Referencias Diario
  const dailySection     = document.getElementById("daily");
  const dailyCarousel    = document.getElementById("dailyCarousel");
  const dailySummary     = document.getElementById("dailySummary");
  const dailyTotalEl     = document.getElementById("dailyTotal");
  const dailyHint        = document.getElementById("dailyHint");

  // Modal Diario
  const dailyModal       = document.getElementById("dailyModal");
  const dailyModalClose  = document.getElementById("dailyModalClose");
  const dailyModalIcon   = document.getElementById("dailyModalIcon");
  const dailyModalTitle  = document.getElementById("dailyModalTitle");
  const dailyModalDesc   = document.getElementById("dailyModalDesc");
  const dailyModalInput  = document.getElementById("dailyModalInput");
  const dailyModalUnit   = document.getElementById("dailyModalUnit");
  const dailyModalSave   = document.getElementById("dailyModalSave");

  // Categor√≠as (factores aproximados; ajusta con tus factores reales)
  const CATEGORIES = [
    { id: "transporte",  label: "Transporte",   unit: "km",     factor: 0.121, icon: "üöó",  hint:"Auto, moto o similar" },
    { id: "energia",     label: "Energ√≠a",      unit: "kWh",    factor: 0.233, icon: "‚ö°",  hint:"Consumo el√©ctrico" },
    { id: "alimentacion",label: "Alimentaci√≥n", unit: "comidas",factor: 2.50,  icon: "üçΩÔ∏è", hint:"Estimaci√≥n por comida" },
    { id: "ropa",        label: "Ropa",         unit: "prendas",factor: 6.50,  icon: "üëï",  hint:"Compra/uso eventual" },
    { id: "electronica", label: "Electr√≥nica",  unit: "h uso",  factor: 0.05,  icon: "üì±",  hint:"Uso dispositivos" },
    { id: "residuos",    label: "Residuos",     unit: "kg",     factor: 0.45,  icon: "üóëÔ∏è",  hint:"Desechos generados" },
  ];

  // Fecha YYYY-MM-DD
  const todayStr = () => new Date().toISOString().split("T")[0];


</script>

<script>
  function renderDailyCards() {
    if (!dailyCarousel) return;
    dailyCarousel.innerHTML = "";

    // Duplicamos el set de tarjetas para "sensaci√≥n" infinita
    const all = [...CATEGORIES, ...CATEGORIES];
    all.forEach(cat => {
      const card = document.createElement("div");
      card.className = "pg-card";
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500 pg-card-icon">${cat.icon}</div>
            <div>
              <h3 class="text-lg font-semibold">${cat.label}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">${cat.hint}</p>
            </div>
          </div>
          <button data-cat="${cat.id}" class="px-4 py-2 rounded-2xl bg-primary text-white font-medium hover:opacity-90">A√±adir</button>
        </div>
      `;
      dailyCarousel.appendChild(card);
    });

    // Listeners botones "A√±adir"
    dailyCarousel.querySelectorAll("button[data-cat]").forEach(btn => {
      btn.addEventListener("click", () => {
        const cat = CATEGORIES.find(c => c.id === btn.dataset.cat);
        openDailyModal(cat);
      });
    });
  }

  function openDailyModal(cat) {
    if (!cat) return;
    dailyModalIcon.textContent = cat.icon;
    dailyModalTitle.textContent = `Registrar ${cat.label}`;
    dailyModalDesc.textContent  = cat.hint;
    dailyModalInput.value = "";
    dailyModalUnit.textContent  = `Unidad: ${cat.unit}`;
    dailyModal.dataset.cat = cat.id;
    dailyModal.classList.remove("hidden");
    dailyModal.classList.add("flex");
  }

  function closeDailyModal() {
    dailyModal.classList.add("hidden");
    dailyModal.classList.remove("flex");
  }

  dailyModalClose.addEventListener("click", closeDailyModal);
  dailyModal.addEventListener("click", (e) => {
    if (e.target === dailyModal) closeDailyModal();
  });
</script>

<script>
  async function ensureUserDoc(uid) {
    if (!DB || !uid) return;
    const ref = doc(DB, "users", uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        createdAt: new Date().toISOString(),
        preferences: { locale: "es-AR" },
        streak: { count: 0, lastEntryDate: null },
        initialSurvey: { completedAt: null },
      }, { merge: true });
    }
  }

  async function setInitialSurveyDone(uid, payload) {
    if (!DB || !uid) return;
    const ref = doc(DB, "users", uid);
    await setDoc(ref, {
      initialSurvey: {
        completedAt: new Date().toISOString(),
        answers: payload || null,
      }
    }, { merge: true });
  }

  async function getDaily(uid, dateStr) {
    const ref = doc(DB, "users", uid, "footprints", dateStr);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
  }

  async function saveDaily(uid, cat, value) {
    const dateStr = todayStr();
    const catDef  = CATEGORIES.find(c => c.id === cat);
    if (!catDef) throw new Error("Categor√≠a inv√°lida");
    const co2e = Number(value) * catDef.factor;

    const ref = doc(DB, "users", uid, "footprints", dateStr);
    const current = await getDaily(uid, dateStr);

    const byCategory = Object.assign({
      transporte: 0, energia: 0, alimentacion: 0, ropa: 0, electronica: 0, residuos: 0,
    }, current?.totals?.byCategory || {});
    byCategory[cat] = (byCategory[cat] || 0) + co2e;

    const inputs = Array.isArray(current?.inputs) ? current.inputs.slice() : [];
    inputs.push({
      category: cat, value: Number(value), unit: catDef.unit, co2e,
      note: null, source: "daily-card",
      at: new Date().toISOString(),
    });

    const total = Object.values(byCategory).reduce((a,b)=>a+b, 0);

    const payload = {
      date: dateStr,
      timestamp: new Date().toISOString(),
      totals: { co2e: Number(total.toFixed(3)), byCategory },
      inputs,
    };

    await setDoc(ref, payload, { merge: true });

    // UI
    dailyTotalEl.textContent = `${payload.totals.co2e.toFixed(2)} kg CO‚ÇÇe`;
    dailyHint.textContent = `Actualizado: ${catDef.label} +${co2e.toFixed(2)} kg CO‚ÇÇe`;
  }

  dailyModalSave.addEventListener("click", async () => {
    const cat = dailyModal.dataset.cat;
    const value = Number(dailyModalInput.value);
    if (!cat || isNaN(value) || value < 0) return;

    const user = window.firebaseAuth?.auth?.currentUser;
    if (!user) { alert("Inicia sesi√≥n primero"); return; }

    dailyModalSave.disabled = true;
    dailyModalSave.textContent = "Guardando‚Ä¶";

    try {
      await saveDaily(user.uid, cat, value);
      closeDailyModal();
    } catch (e) {
      console.error(e);
      alert("No se pudo guardar");
    } finally {
      dailyModalSave.disabled = false;
      dailyModalSave.textContent = "Guardar";
    }
  });
</script>




    <div
      id="contactModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-primary">Contacto</h3>
          <button
            id="closeContactModal"
            class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <div class="flex items-center">
            <svg
              class="w-5 h-5 mr-3 text-primary"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
              ></path>
            </svg>
            <span>+54 379 4709835</span>
          </div>
          <div class="flex items-center">
            <svg
              class="w-5 h-5 mr-3 text-primary"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
              ></path>
              <path
                d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
              ></path>
            </svg>
            <span>powergreen_app@gmail.com</span>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button
            id="copyEmailBtn"
            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg text-sm"
          >
            Copiar Email
          </button>
        </div>
      </div>
    </div>
    
  
<!-- === PG minimal patch (no UI changes) === -->
<script>
(function(){
  if (window.__PG_PATCH_APPLIED__) return;
  window.__PG_PATCH_APPLIED__ = true;

  function waitForFirebaseReady(timeoutMs){
    timeoutMs = timeoutMs || 8000;
    return new Promise(function(resolve, reject){
      var t0 = Date.now();
      (function check(){
        if (window.firebaseAuth && window.firebaseAuth.firestore && window.firebaseAuth.firestore.api) return resolve();
        if (Date.now() - t0 > timeoutMs) return reject(new Error("Firebase no inicializ√≥ a tiempo (patch)"));
        setTimeout(check, 30);
      })();
    });
  }

  function todayStr(){ return new Date().toISOString().split("T")[0]; }

  waitForFirebaseReady().then(function(){
    var FAPI = window.firebaseAuth.firestore.api;
    var DB   = window.firebaseAuth.firestore.db;
    var doc = FAPI.doc, setDoc = FAPI.setDoc, getDoc = FAPI.getDoc;

    // Exponer referencias
    window.PG = { DB: DB, FAPI: FAPI, doc: doc, setDoc: setDoc, getDoc: getDoc };

    // --- Helpers (sobrescribir para que no fallen por DB undefined) ---
    window.ensureUserDoc = async function(uid){
      if (!uid) return;
      var ref = doc(DB, "users", uid);
      var snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          createdAt: new Date().toISOString(),
          preferences: { locale: "es-AR" },
          streak: { count: 0, lastEntryDate: null },
          initialSurvey: { completedAt: null }
        }, { merge: true });
      }
    };

    window.setInitialSurveyDone = async function(uid, payload){
      if (!uid) return;
      var ref = doc(DB, "users", uid);
      await setDoc(ref, {
        initialSurvey: {
          completedAt: new Date().toISOString(),
          answers: payload || null
        }
      }, { merge: true });
    };

    window.getDaily = async function(uid, dateStr){
      if (!uid) return null;
      var ref = doc(DB, "users", uid, "footprints", dateStr);
      var snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    };

    // Si existen categor√≠as en otro script, resp√©talas; sino definimos una m√≠nima por si las dudas.
    var CATEGORIES = window.CATEGORIES || [
      { id: "transporte", unit: "km", factor: 0.121, label: "Transporte" },
      { id: "energia", unit: "kWh", factor: 0.233, label: "Energ√≠a" },
      { id: "alimentacion", unit: "comidas", factor: 2.5, label: "Alimentaci√≥n" },
      { id: "residuos", unit: "kg", factor: 0.45, label: "Residuos" }
    ];

    window.saveDaily = async function(uid, cat, value){
      if (!uid) return;
      var dateStr = todayStr();
      var catDef = (window.CATEGORIES || CATEGORIES).find(function(c){ return c.id === cat; });
      if (!catDef) throw new Error("Categor√≠a inv√°lida");
      var co2e = Number(value) * Number(catDef.factor || 0);

      var ref = doc(DB, "users", uid, "footprints", dateStr);
      var current = await window.getDaily(uid, dateStr);

      var byCategory = Object.assign({
        transporte: 0, energia: 0, alimentacion: 0, ropa: 0, electronica: 0, residuos: 0
      }, current && current.totals && current.totals.byCategory || {});
      byCategory[cat] = (byCategory[cat] || 0) + co2e;

      var inputs = Array.isArray(current && current.inputs) ? current.inputs.slice() : [];
      inputs.push({
        category: cat, value: Number(value), unit: catDef.unit || "", co2e: co2e,
        source: "daily-card", at: new Date().toISOString()
      });

      var total = Object.keys(byCategory).reduce(function(a,k){ return a + (byCategory[k] || 0); }, 0);
      var payload = {
        date: dateStr,
        timestamp: new Date().toISOString(),
        totals: { co2e: Number(total.toFixed(3)), byCategory: byCategory },
        inputs: inputs
      };
      await setDoc(ref, payload, { merge: true });

      // Log requerido
      console.log("[Diario] Guardado hoy:", { categoria: cat, valor: value, co2e: co2e.toFixed(2), total: payload.totals.co2e.toFixed(2) });

      // Actualizar UI si existen esos nodos
      try {
        var totalEl = document.getElementById("dailyTotal");
        var hintEl  = document.getElementById("dailyHint");
        if (totalEl) totalEl.textContent = payload.totals.co2e.toFixed(2) + " kg CO‚ÇÇe";
        if (hintEl) hintEl.textContent  = "Actualizado: " + (catDef.label || cat) + " +" + co2e.toFixed(2) + " kg CO‚ÇÇe";
      } catch(e){}
    };

    // Cargar consumo del d√≠a y log a consola
    window.loadToday = async function(uid){
      var d = await window.getDaily(uid, todayStr());
      if (!d) {
        console.log("[Diario] Hoy sin registros.");
        var totalEl = document.getElementById("dailyTotal");
        var hintEl  = document.getElementById("dailyHint");
        if (totalEl) totalEl.textContent = "0 kg CO‚ÇÇe";
        if (hintEl)  hintEl.textContent  = "A√∫n no registraste nada hoy.";
        return;
      }
      var total = (d.totals && d.totals.co2e) || 0;
      console.log("[Diario] Consumo de hoy:", d);
      try {
        var totalEl = document.getElementById("dailyTotal");
        var hintEl  = document.getElementById("dailyHint");
        if (totalEl) totalEl.textContent = Number(total).toFixed(2) + " kg CO‚ÇÇe";
        if (hintEl)  hintEl.textContent  = "√öltima actualizaci√≥n: " + (d.timestamp || "");
      } catch(e){}
    };

    // Re-render diario cards si el proyecto ya las define; si no, no hacemos nada visual (respetar dise√±o)
    if (typeof window.renderDailyCards === "function") {
      // no toca dise√±o, solo aseguro que exista al menos una vez
      try { window.renderDailyCards(); } catch(e){}
    }

    // --- Progreso: sobreescribir de forma segura para que no llame window.progressChart ---
    window.updateProgressChart = async function(){
      var user = window.firebaseAuth && window.firebaseAuth.auth && window.firebaseAuth.auth.currentUser;
      if (!user) return;
      try {
        var history = await window.firebaseAuth.firestore.getFootprintHistory(user.uid);
        console.log("[Progreso] Historial:", history);

        var labels = history.map(function(h){ return h.date; });
        var values = history.map(function(h){ return Number(h.total || (h.totals && h.totals.co2e) || 0); });

        var noDataEl = document.getElementById("noProgressData");
        if (noDataEl) noDataEl.style.display = values.length ? "none" : "block";

        var c = document.getElementById("progressChart");
        if (!c || !c.getContext) return;
        var ctx = c.getContext("2d");
        if (window.pgProgressChart && typeof window.pgProgressChart.destroy === "function") {
          window.pgProgressChart.destroy();
        }
        window.pgProgressChart = new Chart(ctx, {
          type: "line",
          data: { labels: labels, datasets: [{ label: "CO‚ÇÇe diario", data: values, tension: 0.25 }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      } catch(e){
        console.error("Error en updateProgressChart:", e);
      }
    };

    // Hook adicional al login para cargar hoy + progreso (sin tocar tu onAuthStateChanged original)
    try {
      window.firebaseAuth.onAuthStateChanged(function(user){
        if (user) {
          window.ensureUserDoc(user.uid).then(function(){
            return window.loadToday(user.uid);
          }).then(function(){
            return window.updateProgressChart();
          }).catch(function(e){ console.warn("Patch post-login:", e); });
        }
      });
    } catch(e){}

  }).catch(function(e){
    console.error(e);
  });
})();
</script>

<script>
(function () {
  const STORAGE_KEY = 'pg-theme';
  const root = document.documentElement;
  const btn = document.getElementById('themeToggle');

  // 1) Aplicar preferencia guardada si existe; si no, seguir al sistema
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved === 'dark' || saved === 'light') {
    root.classList.toggle('dark', saved === 'dark');
  }
  // Si NO hay preferencia guardada, tu c√≥digo actual ya sigue al sistema (prefers-color-scheme)

  // 2) Toggle manual
  function updateIcon() {
    if (!btn) return;
    btn.textContent = root.classList.contains('dark') ? 'üåô' : '‚òÄÔ∏è';
  }

  if (btn) {
    updateIcon();
    btn.addEventListener('click', () => {
      const isDark = root.classList.toggle('dark');
      localStorage.setItem(STORAGE_KEY, isDark ? 'dark' : 'light');
      updateIcon();
      // Si tu gr√°fico depende del tema, lo refrescamos:
      if (typeof updateProgressChart === 'function') updateProgressChart();
    });
  }

  // 3) Si quieres que NO cambie con el sistema (solo respetar lo guardado),
  // comenta las siguientes dos l√≠neas en tu c√≥digo original:
  // window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ...)
})();
</script>

<!-- === /PG minimal patch === -->

</body>
</html>
