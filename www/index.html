<!DOCTYPE html>
<html lang="es">
  <head>
    <meta
      http-equiv="Content-Security-Policy"
      content="
  default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
  connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://firebaseinstallations.googleapis.com;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.gstatic.com https://www.googletagmanager.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com;
  img-src 'self' data: blob: https://*.googleapis.com https://*.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com;
  frame-src *;
  style-src * 'unsafe-inline';
  font-src * data:;
  upgrade-insecure-requests;
  block-all-mixed-content;
"
    />

    <meta charset="UTF-8" />
    <title>PowerGreen - Reduce Tu Huella de Carbono</title>
    <script type="module">
      // Importa todas las funciones necesarias
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
      // A√±ade esta l√≠nea para importar Firestore
      import {
        getFirestore,
        collection,
        doc,
        setDoc,
        getDoc,
        query,
        orderBy,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHGXC-YZXmNSAN5JfPdcg89zQwPjbAD04",
        authDomain: "powergreen-683b8.firebaseapp.com",
        projectId: "powergreen-683b8",
        storageBucket: "powergreen-683b8.appspot.com",
        messagingSenderId: "935756958478",
        appId: "1:935756958478:web:e8697d296a03185a54a55f",
        measurementId: "G-2787W6MD4X",
      };

      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const storage = getStorage(app);
      // A√±ade esta l√≠nea para inicializar Firestore
      const db = getFirestore(app);

      // Exp√≥n las funciones necesarias al scope global
      window.firebaseAuth = {
        auth,
        signInWithEmailAndPassword: (email, password) =>
          signInWithEmailAndPassword(auth, email, password),
        createUserWithEmailAndPassword: (email, password) =>
          createUserWithEmailAndPassword(auth, email, password),
        signOut: () => signOut(auth),
        onAuthStateChanged: (callback) => onAuthStateChanged(auth, callback),
        // A√±ade Firestore a las funciones expuestas
        firestore: {
          db,
          api: { doc, setDoc, getDoc, collection, query, orderBy, getDocs },
          saveFootprint: async (userId, footprintData) => {
            try {
              // Usamos la fecha como ID del documento para facilitar la actualizaci√≥n diaria
              const footprintRef = doc(
                db,
                "users",
                userId,
                "footprints",
                footprintData.date
              );

              await setDoc(footprintRef, footprintData, { merge: true }); // merge: true permite actualizar sin borrar otros campos

              return true;
            } catch (error) {
              console.error("Error saving footprint:", error);
              return false;
            }
          },
          testConnection: async () => {
            try {
              const testRef = doc(db, "test", "connection");
              await setDoc(testRef, {
                test: "Conexi√≥n exitosa",
                timestamp: new Date(),
              });
              const docSnap = await getDoc(testRef);
              return docSnap.exists();
            } catch (error) {
              console.error("Error testing connection:", error);
              return false;
            }
          },
          getFootprintHistory: async (userId) => {
            try {
              const footprintsRef = collection(
                db,
                "users",
                userId,
                "footprints"
              );
              const q = query(footprintsRef, orderBy("timestamp", "desc"));
              const querySnapshot = await getDocs(q);

              const history = [];
              querySnapshot.forEach((doc) => {
                history.push(doc.data());
              });

              return history;
            } catch (error) {
              console.error("Error getting footprint history:", error);
              return [];
            }
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#254D32", // verde bosque (para botones/accents principales)
              secondary: "#6B7F5B", // verde oliva/salvia (para elementos secundarios)
              accent: "#A3B18A", // salvia claro (chips, badges, resaltados suaves)
              ink: "#1F3D2B", // texto principal (verde muy oscuro legible)
              surface: "#F8EBCF", // crema (fondos/containers claros)
            },
            boxShadow: {
              soft: "0 10px 30px rgba(0,0,0,.08)",
            },
            borderRadius: {
              "2xl": "1.25rem",
            },
          },
        },
        darkMode: "class",
      };

      // Detectar modo oscuro
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        //document.documentElement.classList.add("dark");
      }
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          if (event.matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        });
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .progress-bar {
        transition: width 1s ease-in-out;
      }

      /* Estilo personalizado para el control deslizante */
      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #d7dcdf;
      }
      .info-tooltip {
        position: relative;
        cursor: pointer;
      }

      .info-tooltip:hover::after {
        content: attr(data-info);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        padding: 8px;
        background: #2c3e50;
        color: white;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #2ecc71;
        cursor: pointer;
      }

      .hidden {
        display: none !important;
      }

      .dark input[type="range"] {
        background: #4b5563;
      }

      .challenge-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .challenge-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .dark .challenge-card:hover {
        box-shadow: 0 10px 20px rgba(255, 255, 255, 0.05);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }
      /* Efectos para el topbar */
      .tab-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }

      /* Efectos para las tarjetas */
      .tip-card:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      /* Efectos para botones */
      button:hover {
        transform: translateY(-1px);
      }

      /* Efectos para inputs */
      input:hover,
      select:hover {
        border-color: #2ecc71;
      }
      /* Animaciones */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .animate-fade-in {
        animation: fadeIn 1s ease-out;
      }

      .animate-slide-up {
        animation: slideUp 0.8s ease-out forwards;
        opacity: 0;
      }

      .animate-bounce {
        animation: bounce 2s infinite;
      }
      /* Animaci√≥n para el modal */
      #contactModal {
        transition: opacity 0.3s ease;
      }

      #contactModal > div {
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }

      #contactModal:not(.hidden) > div {
        transform: scale(1);
      }
      /* Animaci√≥n de spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }

      /* Transici√≥n para el loader global */
      #globalLoader {
        transition: opacity 0.5s ease-out;
      }
      /* --- Carrusel Diario (scroll snap) --- */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .pg-carousel {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding: 0.25rem 0.25rem 1rem;
      }
      .pg-card {
        scroll-snap-align: start;
        min-width: 85%;
        max-width: 85%;
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 1rem;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          background 0.25s ease;
      }
      /* HOME ‚Üí Desglose: tarjetas compactas */
#homeBreakdown .pg-card{
  min-height: 0;      /* anula el 280px */
  min-width: 0;
  max-width: 100%;
  padding: 0.75rem;   /* opcional: las hace un poco m√°s compactas */
}

      .dark .pg-card {
        background: #111827;
        box-shadow: 0 10px 30px rgba(255, 255, 255, 0.06);
      }
      .pg-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.12);
      }

      .pg-card {
        scroll-snap-align: center;
        min-width: 90%;
        max-width: 90%;
        min-height: 280px; /* <- agrega altura m√≠nima */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 1.25rem;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          background 0.25s ease;
      }
      .dark .pg-card-icon {
        border-radius: 1.25rem;
        background: rgba(187, 221, 199, 0.13);
      }

      /* Modal diario */
      .pg-modal-backdrop {
        background: rgba(0, 0, 0, 0.5);
      }
    </style>

    <!-- PowerGreen style guide additions -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&family=SF+Pro+Text:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap"
      rel="stylesheet"
    />
    <style type="text/tailwindcss">
      :root {
        --primary-light: #254d32;
        --secondary-light: #6b7f5b;
        --accent-light: #a3b18a;
        --ink-light: #1f3d2b;
        --surface-light: #f8ebcf;

        --primary-dark: #a3b18a;
        --secondary-dark: #6b7f5b;
        --accent-dark: #254d32;
        --ink-dark: #f8ebcf;
        --surface-dark: #1f3d2b;

        --radius-sm: 12px;
        --radius-md: 16px;
        --radius-lg: 20px;
      }
      .font-display {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto,
          sans-serif;
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
    </style>

    <link
      href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* === Section Loader Overlay === */
      .section-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 30;
      }
      .dark .section-loader {
        background: rgba(255, 255, 255, 0.06);
      }
      .section-loader .pg-spinner {
        width: 56px;
        height: 56px;
        border-radius: 9999px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top-color: var(--primary-color);
        animation: pgspin 1s linear infinite;
      }
      .dark .section-loader .pg-spinner {
        border: 4px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--primary-color);
      }
      @keyframes pgspin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Ocultar flechas en Chrome, Safari, Edge */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Ocultar flechas en Firefox */
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-surface dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <!-- Splash/Loader con video + logo -->
    <!-- <div id="globalLoader" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 transition-opacity duration-500">
  <div class="flex flex-col items-center">
     Si pones el archivo assets/video/splash.mp4 se reproduce; si no, queda el logo animado 
    <video id="splashVideo" class="w-40 h-40 rounded-2xl shadow-soft mb-4" autoplay muted playsinline preload="auto">
      <source src="" type="video/mp4" />
    </video>

     
    <div class="flex items-center gap-3 text-white">
      <svg width="42" height="42" viewBox="0 0 24 24" class="animate-pulse">
        <path fill="currentColor" d="M7 20c0-2 2-4 5-4s5 2 5 4-2 4-5 4-5-2-5-4Zm7.5-10.5a1.5 1.5 0 1 1 3.001.001A1.5 1.5 0 0 1 14.5 9.5ZM12 2a2 2 0 1 1 0 4a2 2 0 0 1 0-4Zm-5 3a1.75 1.75 0 1 1 0 3.5A1.75 1.75 0 0 1 7 5Zm-2 6a2 2 0 1 1 0 4a2 2 0 0 1 0-4Z"/>
      </svg>
      <span class="text-2xl font-semibold tracking-wide">PowerGreen</span>
    </div>

  </div>
</div> -->

    <header class="sticky top-0 z-40 glass-effect">
      <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-end">
        <button
          id="logoutBtn"
          class="px-3 py-1.5 rounded-full bg-primary text-white text-sm"
        >
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!--Onboarding -->

    <main class="container mx-auto px-4 py-6">
      <!-- === Inicio (Home) ‚Äî estilo Stitch integrado === -->
      <section id="home" class="tab-content py-4">
        <div class="container mx-auto max-w-md px-4">
          <!-- Saludo + CTA recalcular -->
          <div class="mb-4 flex items-center justify-between">
            <h1
              class="text-2xl font-bold tracking-tight text-[var(--text-primary)]"
            >
              Hola!<span id="homeUserName"></span>
            </h1>
            <button
              id="recalcBtn"
              class="inline-flex items-center justify-center rounded-full bg-[var(--accent-light)] py-2 px-3 text-xs font-bold text-black shadow-sm active:scale-95"
            >
              <span class="material-symbols-outlined">calculate</span>
            </button>
          </div>

          <!-- Huella actual -->
          <section
            class="mb-6 rounded-2xl bg-white dark:bg-gray-900 p-4 shadow-sm backdrop-blur-sm"
          >
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-[var(--text-primary)]">
                Huella actual
              </h2>
              <div
                id="homeDelta"
                class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-[var(--accent-color)] hidden"
              >
                <span class="material-symbols-outlined text-sm mr-1"
                  >arrow_downward</span
                ><span id="homeDeltaText"></span>
              </div>
            </div>
            <div class="flex items-end justify-between">
              <p class="text-4xl font-bold text-[var(--text-primary)]">
                <span id="homeTotal">‚Äî</span>
                <span class="text-base font-normal text-[var(--text-secondary)]"
                  >kg CO‚ÇÇe</span
                >
              </p>
              <p class="text-sm text-[var(--text-secondary)]">
                Actualizado: <span id="homeDate">‚Äî</span>
              </p>
            </div>
          </section>

          <!-- Desglose -->
          <section class="mb-6">
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-3">
              Desglose de categor√≠as
            </h3>
            <div class="grid grid-cols-2 gap-4" id="homeBreakdown">
              <!-- Tarjetas generadas por JS -->
            </div>
          </section>

          <!-- Acciones r√°pidas -->
          <section class="mb-6">
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-3">
              Acciones r√°pidas
            </h3>
            <div class="space-y-3">
              <button
                id="quickAddBtn"
                class="flex w-full items-center justify-center rounded-xl bg-[var(--primary-color)] py-3 px-4 text-base font-bold text-black shadow-sm active:scale-95"
              >
                <span class="material-symbols-outlined mr-2">add_circle</span>
                Cargar hoy
              </button>
              <button
                id="quickChallengeBtn"
                class="flex w-full items-center justify-center rounded-xl bg-white dark:bg-gray-900 py-3 px-4 text-base font-bold text-[var(--text-primary)] shadow-sm active:scale-95"
              >
                <span class="material-symbols-outlined mr-2">emoji_events</span>
                Unirse a un reto
              </button>
            </div>
          </section>

          <!-- Consejos / Comunidad placeholders -->
          <section>
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-3">
              Consejos destacados
            </h3>
            <div
              class="flex flex-col items-center justify-center rounded-2xl bg-white dark:bg-gray-900 p-6 text-center shadow-sm"
            >
              <span
                class="material-symbols-outlined text-5xl text-[var(--accent-color)] mb-2"
                >eco</span
              >
              <p
                class="text-base font-semibold text-[var(--text-primary)] mb-1"
              >
                Sin consejos destacados
              </p>
              <p class="text-sm text-[var(--text-secondary)]">
                Pronto tendremos consejos para ti.
              </p>
            </div>
          </section>
        </div>
      </section>
      <!-- Secci√≥n de Login -->
      <section id="auth-section" class="py-6">
        <div
          class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden p-8"
        >
          <div class="text-center mb-8">
            <img
              class="rounded-full shadow-md w-20 h-20 mx-auto mb-4"
              src="index.png"
              alt="PowerGreen Logo"
            />
            <h2 class="text-3xl font-bold text-primary">
              Bienvenido a PowerGreen
            </h2>
            <p class="text-gray-600 dark:text-gray-400">
              Reduce tu huella de carbono
            </p>
          </div>

          <div id="loginForm" class="space-y-6 animate-fade-in">
            <div>
              <label class="block text-sm font-medium mb-1"
                >Correo electr√≥nico</label
              >
              <input
                type="email"
                id="loginEmail"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Contrase√±a</label>
              <input
                type="password"
                id="loginPassword"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <button
              id="loginBtn"
              class="w-full bg-primary hover:bg-secondary text-white py-3 rounded-lg transition-all"
            >
              Iniciar Sesi√≥n
            </button>
            <p class="text-center text-sm">
              ¬øNo tienes cuenta?
              <button id="showRegister" class="text-primary font-medium">
                Reg√≠strate
              </button>
            </p>
          </div>

          <div id="registerForm" class="space-y-6 hidden animate-fade-in">
            <!-- <div>
                        <label class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" id="registerName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700">
                    </div> -->
            <div>
              <label class="block text-sm font-medium mb-1"
                >Correo electr√≥nico</label
              >
              <input
                type="email"
                id="registerEmail"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Contrase√±a</label>
              <input
                type="password"
                id="registerPassword"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700"
              />
              <p class="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
            </div>
            <button
              id="registerBtn"
              class="w-full bg-accent hover:bg-blue-600 text-white py-3 rounded-lg transition-all"
            >
              Crear Cuenta
            </button>
            <p class="text-center text-sm">
              ¬øYa tienes cuenta?
              <button id="showLogin" class="text-primary font-medium">
                Inicia Sesi√≥n
              </button>
            </p>
          </div>

          <div id="authMessage" class="mt-4 text-center hidden"></div>
        </div>
      </section>

      <!-- Calculadora de Huella de Carbono -->
      <section id="calculator" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Calcula Tu Huella de Carbono
        </h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Transporte</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2"
                  >¬øCu√°ntos kil√≥metros conduces por semana?</label
                >

                <input
                  type="range"
                  min="0"
                  max="500"
                  value="100"
                  class="slider w-full"
                  id="driveDistance"
                />
                <div class="flex justify-between">
                  <span>0 km</span>
                  <span id="drivingValue">100 km</span>
                  <span>500 km</span>
                </div>
              </div>
              <div>
                <label class="block mb-2">¬øCu√°ntos vuelos tomas al a√±o?</label>

                <input
                  type="range"
                  min="0"
                  max="20"
                  value="2"
                  class="slider w-full"
                  id="flightsPerYear"
                />
                <div class="flex justify-between">
                  <span>0</span>
                  <span id="flightsValue">2 vuelos</span>
                  <span>20</span>
                </div>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia usas transporte p√∫blico?</label
                >

                <select
                  id="publicTransport"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">Nunca</option>
                  <option value="1">Raramente (1-2 veces al mes)</option>
                  <option value="2" selected="">
                    Ocasionalmente (1-2 veces por semana)
                  </option>
                  <option value="3">
                    Frecuentemente (3-5 veces por semana)
                  </option>
                  <option value="4">Diariamente</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Energ√≠a en el Hogar</h3>
            <div class="space-y-4">
              <div>
                <div class="flex items-center">
                  <label class="block mb-2"
                    >¬øCu√°l es tu consumo mensual de electricidad (kWh)?</label
                  >
                  <span
                    class="info-tooltip ml-1"
                    data-info="Puedes consultarlo en la p√°gina de tu proveedor de energ√≠a. El consumo promedio en hogares es de 250-300 kWh mensuales."
                  >
                    <svg
                      class="w-4 h-4 inline text-gray-500 dark:text-gray-400"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="1000"
                  value="300"
                  class="slider w-full"
                  id="electricityUsage"
                />
                <div class="flex justify-between">
                  <span>0 kWh</span>
                  <span id="electricityValue">300 kWh</span>
                  <span>1000 kWh</span>
                </div>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øUtilizas fuentes de energ√≠a renovable? (Solar, E√≥lica o
                  Hidr√≥lica)</label
                >

                <select
                  id="renewableEnergy"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">No</option>
                  <option value="1">Parcialmente</option>
                  <option value="2">S√≠, completamente</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Alimentaci√≥n & Consumo</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia consumes productos animales?</label
                >
                <select
                  id="dietType"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="4">Diariamente, varias veces</option>
                  <option value="3" selected>Diariamente, una vez</option>
                  <option value="2">Unas pocas veces por semana</option>
                  <option value="1">Raramente</option>
                  <option value="0">Nunca (vegano/vegetariano)</option>
                </select>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia compras ropa nueva?</label
                >
                <select
                  id="clothingHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="3">Muy frecuentemente (mensualmente)</option>
                  <option value="2" selected>
                    Ocasionalmente (trimestralmente)
                  </option>
                  <option value="1">Raramente (anualmente)</option>
                  <option value="0">Casi nunca / Solo de segunda mano</option>
                </select>
              </div>
              <div>
                <label class="block mb-2"
                  >¬øCon qu√© frecuencia compras electr√≥nicos nuevos?</label
                >
                <select
                  id="electronicsHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="3">Muy frecuentemente (cada 1-2 a√±os)</option>
                  <option value="2" selected>
                    Ocasionalmente (cada 3-5 a√±os)
                  </option>
                  <option value="1">Raramente (cada 5+ a√±os)</option>
                  <option value="0">Casi nunca / Solo de segunda mano</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4">Gesti√≥n de Residuos</h3>
            <div class="space-y-4">
              <div>
                <label class="block mb-2">¬øReciclas?</label>

                <select
                  id="recyclingHabits"
                  class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base"
                >
                  <option value="0">Nunca</option>
                  <option value="1">A veces</option>
                  <option value="2" selected="">Regularmente</option>
                  <option value="3">Siempre, y hago compost</option>
                </select>
              </div>
            </div>
          </div>

          <button
            id="calculateBtn"
            class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 w-full md:w-auto"
          >
            Calcular Mi Huella
          </button>
        </div>

        <!-- Secci√≥n de Resultados (inicialmente oculta) -->
        <div id="resultsSection" class="mt-8 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-primary">
              Resultados de Tu Huella de Carbono
            </h3>

            <div class="mb-6 text-center">
              <p class="text-lg mb-2">Tu huella de carbono anual estimada:</p>
              <p class="text-4xl font-bold text-primary">
                <span id="totalCarbonFootprint">0</span> toneladas CO‚ÇÇe
              </p>
              <p class="text-sm mt-2 text-gray-600 dark:text-gray-400">
                El promedio es <span id="averageComparison">5</span> toneladas
                CO‚ÇÇe por persona
              </p>

              <!-- Mensaje personalizado por nivel de huella -->
              <div id="personalizedMessage" class="mt-4 hidden"></div>
            </div>

            <div class="mb-6">
              <h4 class="font-semibold mb-2">Tu impacto por categor√≠a:</h4>
              <div class="h-64">
                <canvas id="footprintChart"></canvas>
              </div>
            </div>

            <div class="mb-6">
              <h4 class="font-semibold mb-2">√Åreas de mejora:</h4>
              <ul id="improvementAreas" class="list-disc pl-5 space-y-2">
                <!-- Se llenar√° din√°micamente -->
              </ul>
            </div>

            <div class="mt-6 flex flex-wrap justify-center gap-4">
              <button
                id="viewTipsBtn"
                class="bg-accent hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Ver Consejos Personalizados
              </button>
              <button
                id="viewChallengesBtn"
                class="bg-secondary hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Unirse a Retos
              </button>
              <button
                id="saveResultsBtn"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300"
              >
                Guardar Resultados
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Secci√≥n Diario (tarjetas deslizables) -->
      <section id="daily" class="tab-content">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-2xl font-semibold mb-4">Carga diaria</h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            Desliza las tarjetas y registra tu huella para hoy en la categor√≠a
            que quieras.
          </p>

          <!-- Carrusel -->
          <div id="dailyCarousel" class="pg-carousel no-scrollbar"></div>

          <!-- Tip: mini resumen del d√≠a -->
          <div
            id="dailySummary"
            class="mt-6 p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-soft"
          >
            <div class="flex items-center justify-between">
              <span class="font-medium">Total de hoy</span>
              <span id="dailyTotal" class="text-lg font-semibold text-primary"
                >0 kg CO‚ÇÇe</span
              >
            </div>
            <p
              id="dailyHint"
              class="text-sm text-gray-600 dark:text-gray-400 mt-1"
            >
              A√∫n no registraste nada hoy.
            </p>
          </div>
        </div>
      </section>

      <!-- Modal de carga diaria -->
      <div
        id="dailyModal"
        class="fixed inset-0 hidden items-center justify-center z-50"
      >
        <div class="absolute inset-0 pg-modal-backdrop"></div>
        <div
          class="relative bg-white dark:bg-gray-900 rounded-2xl shadow-soft w-full max-w-md mx-4 p-6"
        >
          <button
            id="dailyModalClose"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
          >
            &times;
          </button>
          <div class="flex items-center gap-3 mb-4">
            <div id="dailyModalIcon" class="pg-card-icon">üå±</div>
            <div>
              <h3 id="dailyModalTitle" class="text-xl font-semibold">
                Registrar
              </h3>
              <p
                id="dailyModalDesc"
                class="text-sm text-gray-600 dark:text-gray-400"
              >
                Carga del d√≠a para esta categor√≠a.
              </p>
            </div>
          </div>
          <div class="space-y-4">
            <label class="block text-sm font-medium">Valor de hoy</label>
            <input
              id="dailyModalInput"
              type="number"
              min="0"
              step="0.01"
              class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-800"
            />
            <p
              id="dailyModalUnit"
              class="text-sm text-gray-600 dark:text-gray-400"
            >
              unidad
            </p>
            <button
              id="dailyModalSave"
              class="w-full py-3 rounded-2xl bg-primary text-white font-semibold hover:opacity-90"
            >
              Guardar
            </button>
          </div>
        </div>
      </div>

      <!-- Secci√≥n de Consejos -->
      <section id="tips" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Consejos Personalizados
        </h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <div id="tipFilters" class="mb-6">
            <h3 class="text-lg font-semibold mb-3">Filtrar por categor√≠a:</h3>
            <div class="flex flex-wrap gap-2">
              <button
                class="tip-filter active px-4 py-2 rounded-full bg-primary text-white"
                data-category="all"
              >
                Todos
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="transport"
              >
                Transporte
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="energy"
              >
                Energ√≠a
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="food"
              >
                Alimentaci√≥n
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="consumption"
              >
                Consumo
              </button>
              <button
                class="tip-filter px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white"
                data-category="waste"
              >
                Residuos
              </button>
            </div>
          </div>

          <div
            id="tipsList"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- Consejos de Transporte -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">Combina Recados</h3>
              <p>
                Planifica tus viajes para combinar m√∫ltiples recados en un solo
                trayecto. Esto puede reducir tu distancia de conducci√≥n hasta un
                30%.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de transporte en 10-15%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">
                Mant√©n la Presi√≥n Correcta de los Neum√°ticos
              </h3>
              <p>
                Mantener tus neum√°ticos correctamente inflados puede mejorar la
                eficiencia de combustible hasta un 3%. Revisa la presi√≥n
                mensualmente.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir consumo de combustible en 2-3%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-blue-500"
              data-category="transport"
            >
              <h3 class="font-semibold text-lg mb-2">Usa Transporte P√∫blico</h3>
              <p>
                Tomar transporte p√∫blico solo una vez a la semana en lugar de
                conducir puede reducir significativamente tu huella de carbono.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 795 kg de CO‚ÇÇ anuales
              </p>
            </div>

            <!-- Consejos de Energ√≠a -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">Cambia a Bombillas LED</h3>
              <p>
                Las luces LED usan hasta 85% menos energ√≠a que las bombillas
                tradicionales y duran 25 veces m√°s.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir uso de energ√≠a en iluminaci√≥n en
                75-80%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">
                Desconecta Electr√≥nicos
              </h3>
              <p>
                Muchos dispositivos consumen energ√≠a incluso cuando est√°n
                apagados. Desconecta cargadores y electr√≥nicos cuando no los
                uses.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir consumo en espera en 5-10%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500"
              data-category="energy"
            >
              <h3 class="font-semibold text-lg mb-2">Ajusta el Termostato</h3>
              <p>
                Baja tu termostato 1-2¬∞C en invierno y s√∫belo 1-2¬∞C en verano
                para ahorrar energ√≠a.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir energ√≠a de calefacci√≥n/refrigeraci√≥n
                en 5-15%
              </p>
            </div>

            <!-- Consejos de Alimentaci√≥n -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">Lunes Sin Carne</h3>
              <p>
                No comer carne solo un d√≠a a la semana puede marcar una gran
                diferencia en tu huella de carbono.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 400 kg de CO‚ÇÇ anuales
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">
                Compra Local y de Temporada
              </h3>
              <p>
                Los alimentos locales y de temporada requieren menos transporte
                y a menudo menos energ√≠a para su producci√≥n.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir huella de carbono de alimentos en
                10-20%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-green-500"
              data-category="food"
            >
              <h3 class="font-semibold text-lg mb-2">
                Reduce el Desperdicio de Alimentos
              </h3>
              <p>
                Planifica comidas, almacena alimentos correctamente y usa sobras
                para reducir la cantidad de comida que tiras.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Ahorrar hasta 300 kg de CO‚ÇÇ anuales
              </p>
            </div>

            <!-- Consejos de Consumo -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">
                Compra Calidad, Compra Menos
              </h3>
              <p>
                Invierte en art√≠culos duraderos y de alta calidad que durar√°n
                m√°s, reduciendo la necesidad de reemplazos frecuentes.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir huella de bienes de consumo en 20%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">Compra de Segunda Mano</h3>
              <p>
                Considera comprar art√≠culos usados. El costo ambiental de
                producci√≥n ya ha sido pagado.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de manufactura en 100%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-purple-500"
              data-category="consumption"
            >
              <h3 class="font-semibold text-lg mb-2">Repara, No Reemplaces</h3>
              <p>
                Aprende habilidades b√°sicas de reparaci√≥n o encuentra servicios
                locales para reparar electr√≥nicos, ropa y otros art√≠culos.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Extender vida √∫til del producto 2-3 veces
              </p>
            </div>

            <!-- Consejos de Residuos -->
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">Comienza a Compostar</h3>
              <p>
                Compostar residuos org√°nicos reduce emisiones de metano de
                vertederos y crea tierra valiosa para plantas.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Reducir emisiones de residuos org√°nicos en
                50%
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">
                Usa Contenedores Reutilizables
              </h3>
              <p>
                Lleva tus propios contenedores para comida para llevar, sobras y
                compras para reducir residuos de empaques desechables.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Eliminar 100+ piezas de empaques desechables
                al a√±o
              </p>
            </div>
            <div
              class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-red-500"
              data-category="waste"
            >
              <h3 class="font-semibold text-lg mb-2">Reciclaje Adecuado</h3>
              <p>
                Aprende las pautas de reciclaje locales para asegurarte de que
                tus art√≠culos realmente se reciclen correctamente.
              </p>
              <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Impacto potencial: Aumentar efectividad del reciclaje en 30%
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Secci√≥n de Retos -->
      <section id="challenges" class="tab-content py-6">
        <h2 class="text-2xl font-bold mb-6 text-primary">
          Retos de Sostenibilidad
        </h2>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
          <h3 class="text-xl font-semibold mb-4">Retos Activos</h3>
          <div id="activeChallengesTodo" class="space-y-4">
            <p class="text-gray-500 dark:text-gray-400 text-center py-4">
              A√∫n no te has unido a ning√∫n reto.
            </p>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-semibold mb-4">Retos Disponibles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Semana Sin Carne</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >7 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Intenta no comer carne durante una semana para reducir
                significativamente tu huella de carbono.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="meatless-week"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">D√≠as Sin Auto</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >5 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Comprom√©tete a usar solo transporte p√∫blico, bicicleta o caminar
                durante 5 d√≠as.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óè</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="no-car-days"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">
                  Fin de Semana Cero Residuos
                </h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >2 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Intenta no producir residuos para vertedero durante un fin de
                semana completo. Recicla, composta o evita residuos por
                completo.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="zero-waste-weekend"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Mes de Ahorro de Energ√≠a</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >30 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Reduce tu consumo de energ√≠a en 20% durante un mes haciendo
                cambios simples en tus h√°bitos diarios.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óè‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="energy-saver-month"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Mes Sin Compras Nuevas</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >30 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Comprom√©tete a no comprar art√≠culos no esenciales nuevos durante
                un mes. Pide prestado, repara o prescinde.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="no-new-stuff-month"
              >
                Unirse al Reto
              </button>
            </div>

            <div
              class="challenge-card bg-white dark:bg-gray-700 rounded-lg shadow-md p-5"
            >
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-lg">Ahorrador de Agua</h4>
                <span
                  class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 px-2 py-1 rounded-full text-xs"
                  >14 d√≠as</span
                >
              </div>
              <p class="mb-4">
                Reduce tu consumo de agua en 25% durante dos semanas mediante
                simples cambios diarios.
              </p>
              <div class="mb-3">
                <span class="text-sm font-medium">Dificultad:</span>
                <div class="flex items-center ml-2">
                  <span class="text-yellow-500">‚óè‚óè‚óã‚óã‚óã</span>
                </div>
              </div>
              <div class="mb-4">
                <span class="text-sm font-medium">Impacto:</span>
                <div class="flex items-center ml-2">
                  <span class="text-green-500">‚óè‚óè‚óè‚óã‚óã</span>
                </div>
              </div>
              <button
                class="join-challenge-btn w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded transition-colors duration-300"
                data-id="water-saver"
              >
                Unirse al Reto
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- === Progreso (Stitch-like) === -->
      <section id="progress" class="tab-content py-6">
        <div class="max-w-md mx-auto px-4">
          <header class="flex items-center p-1 pb-4 justify-between">
            <h2 class="text-xl font-bold leading-tight flex-1 text-center">
              Progreso
            </h2>
          </header>

          <main class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div
                class="bg-white p-4 rounded-3xl flex flex-col gap-2 border border-[var(--primary-color)]/20"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="material-symbols-outlined text-3xl text-[var(--primary-color)]"
                    >star</span
                  >
                  <p class="text-[var(--text-secondary)] text-sm font-medium">
                    Puntos
                  </p>
                </div>
                <p id="pgPoints" class="text-3xl font-bold tracking-tight">0</p>
                <p
                  id="pgPointsDelta"
                  class="text-[var(--primary-color)] text-sm font-medium hidden"
                >
                  +0%
                </p>
              </div>
              <div
                class="bg-white p-4 rounded-3xl flex flex-col gap-2 border border-[var(--primary-color)]/20"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="material-symbols-outlined text-3xl text-[var(--primary-color)]"
                    >local_fire_department</span
                  >
                  <p class="text-[var(--text-secondary)] text-sm font-medium">
                    Racha
                  </p>
                </div>
                <p id="pgStreak" class="text-3xl font-bold tracking-tight">0</p>
                <p
                  id="pgStreakDelta"
                  class="text-[var(--primary-color)] text-sm font-medium hidden"
                >
                  +0
                </p>
              </div>
            </div>

            <div class="flex flex-col gap-4">
              <!-- Objetivo Diario Section -->
              <div
                class="bg-white p-6 rounded-3xl border border-[var(--primary-color)]/20 flex items-center justify-center"
              >
                <div class="ring-outer-card">
                  <div class="progress-ring w-[180px] h-[180px] relative">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                      <circle
                        class="text-[var(--accent-color,#287a4a)]"
                        cx="50"
                        cy="50"
                        r="45"
                        fill="transparent"
                        stroke="currentColor"
                        stroke-width="10"
                      ></circle>
                      <circle
                        id="pgRing"
                        class="progress-ring-circle text-[var(--primary-color)]"
                        cx="50"
                        cy="50"
                        r="45"
                        fill="transparent"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-width="10"
                      />
                    </svg>
                    <div
                      class="absolute inset-0 flex flex-col items-center justify-center"
                    >
                      <p class="text-[var(--text-secondary)] text-sm">
                        Objetivo diario
                      </p>
                      <p class="text-2xl font-bold">
                        <span id="pgDaily">0</span>/<span id="pgGoal">100</span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Emisiones de Carbono Section -->
              <div
                class="bg-white p-6 rounded-3xl border border-[var(--primary-color)]/20"
              >
                <div class="flex flex-col gap-2">
                  <p class="text-base font-medium text-[var(--text-secondary)]">
                    Emisiones de carbono
                  </p>
                  <p id="pgChange" class="text-4xl font-bold tracking-tighter">
                    ‚Äî
                  </p>
                  <div class="flex gap-1 items-center">
                    <p class="text-[var(--text-secondary)] text-sm font-normal">
                      vs registro anterior
                    </p>
                    <span
                      id="pgChangeIcon"
                      class="material-symbols-outlined text-base"
                      >trending_flat</span
                    >
                    <p id="pgChangePct" class="text-sm font-medium">0%</p>
                  </div>
                </div>
                <!-- Hidden canvas to preserve existing logic if needed -->
                <div class="mt-4 h-40">
                  <canvas id="progressChart"></canvas>
                  <p
                    id="noProgressData"
                    class="text-center py-4 text-gray-500 dark:text-gray-400"
                  >
                    Registra tu huella en el tiempo calcul√°ndola regularmente.
                  </p>
                </div>
              </div>

              <!-- Insignias Section -->
              <div
                class="bg-white p-6 rounded-3xl border border-[var(--primary-color)]/20"
              >
                <h3 class="text-lg font-bold px-1 pb-2 pt-2">Insignias</h3>
                <div class="flex gap-3 p-1 flex-wrap">
                  <div
                    class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[var(--accent-color,#287a4a)]/20 pl-3 pr-4"
                  >
                    <span
                      class="material-symbols-outlined text-[var(--primary-color)]"
                      >eco</span
                    >
                    <p class="text-[var(--primary-color)] text-sm font-medium">
                      Principiante
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </main>
        </div>
      </section>
    </main>

    <footer
      id="bottomNav"
      class="sticky bottom-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg border-t border-gray-200"
    >
      <nav class="mx-auto flex h-16 max-w-md justify-around">
        <a
          class="flex flex-1 flex-col items-center justify-center gap-0.5 tab-button text-[var(--primary-color)]"
          data-tab="home"
          href="#"
        >
          <span class="material-symbols-outlined">home</span>
          <p class="text-[10px] font-medium">Inicio</p>
        </a>
        <a
          class="flex flex-1 flex-col items-center justify-center gap-0.5 tab-button text-[var(--text-secondary)] hover:text-[var(--primary-color)]"
          data-tab="daily"
          href="#"
        >
          <span class="material-symbols-outlined">event_note</span>
          <p class="text-[10px] font-medium">Diario</p>
        </a>
        <a
          class="flex flex-1 flex-col items-center justify-center gap-0.5 tab-button text-[var(--text-secondary)] hover:text-[var(--primary-color)]"
          data-tab="progress"
          href="#"
        >
          <span class="material-symbols-outlined">bar_chart</span>
          <p class="text-[10px] font-medium">Progreso</p>
        </a>
        <a
          class="flex flex-1 flex-col items-center justify-center gap-0.5 tab-button text-[var(--text-secondary)] hover:text-[var(--primary-color)]"
          data-tab="tips"
          href="#"
        >
          <span class="material-symbols-outlined">tips_and_updates</span>
          <p class="text-[10px] font-medium">Consejos</p>
        </a>
        <a
          class="flex flex-1 flex-col items-center justify-center gap-0.5 tab-button text-[var(--text-secondary)] hover:text-[var(--primary-color)]"
          data-tab="challenges"
          href="#"
        >
          <span class="material-symbols-outlined">military_tech</span>
          <p class="text-[10px] font-medium">Desaf√≠os</p>
        </a>
      </nav>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- Safe element helpers ---
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const safeOn = (el, ev, fn) => {
          if (el) el.addEventListener(ev, fn);
        };

        // --- Core UI elements ---
        const globalLoader = document.getElementById("globalLoader");
        const header = document.querySelector("header");
        const footer = document.getElementById("bottomNav");
        const authSection = document.getElementById("auth-section");
        const tabContents = $$(".tab-content");

        // NUEVO === Onboarding overlay helpers ===
        const onboardingOverlay = document.getElementById("onboardingOverlay");
        const onboardingFrame = document.getElementById("onboardingFrame");

        /**
         * Devuelve true si el usuario NO tiene huellas guardadas (usuario nuevo)
         */
        async function shouldShowOnboarding(uid) {
          try {
            const history =
              await window.firebaseAuth.firestore.getFootprintHistory(uid);
            const hasAny = Array.isArray(history) && history.length > 0;
            return !hasAny;
          } catch (e) {
            console.warn("No se pudo consultar huellas:", e);
            // Si falla la consulta, por seguridad NO bloqueamos al usuario: no mostramos onboarding.
            return false;
          }
        }

        function showOnboardingOverlay() {
          if (!onboardingOverlay) return;
          onboardingOverlay.classList.remove("hidden");
          // Opcional: ocultar header/footer mientras est√° el overlay
          if (header) header.style.display = "none";
          if (footer) footer.style.display = "none";
        }

        function hideOnboardingOverlay() {
          if (!onboardingOverlay) return;
          onboardingOverlay.classList.add("hidden");
          if (header) header.style.display = "flex";
          if (footer) footer.style.display = "block";
        }

        // Recibe el "fin del onboarding" desde onboarding.html
        function handleOnboardingMessage(ev) {
          // Aceptamos el mensaje del mismo origen. Si sirves archivos estaticos, puedes omitir el check.
          // if (ev.origin !== window.location.origin) return;
          if (ev?.data && ev.data.type === "pg-onboarding-completed") {
            // Dejamos que el toast "¬°Onboarding completado!" aparezca un instante
            setTimeout(() => {
              hideOnboardingOverlay();
              // Llevar al usuario a la Calculadora
              try {
                showTab("calculator");
              } catch {}
            }, 700);
          }
        }

        // Escuchar UNA sola vez durante la sesi√≥n
        window.addEventListener("message", handleOnboardingMessage, false);

        // Bottom nav buttons
        const bottomTabs = footer ? footer.querySelectorAll("[data-tab]") : [];

        // Calculator bits
        const calculateBtn = document.getElementById("calculateBtn");
        const resultsSection = document.getElementById("resultsSection");

        // Range inputs
        const driveDistance = document.getElementById("driveDistance");
        const drivingValue = document.getElementById("drivingValue");
        const flightsPerYear = document.getElementById("flightsPerYear");
        const flightsValue = document.getElementById("flightsValue");
        const electricityUsage = document.getElementById("electricityUsage");
        const electricityValue = document.getElementById("electricityValue");

        // Theme toggle
        const themeToggle = document.getElementById("themeToggle");
        safeOn(themeToggle, "click", () => {
          const root = document.documentElement;
          const isDark = root.classList.toggle("dark");
          try {
            localStorage.setItem("pg-theme", isDark ? "dark" : "light");
          } catch {}
        });

        // --- Tab handling ---
        function activateNav(tabId) {
          bottomTabs.forEach((a) => {
            if (a.getAttribute("data-tab") === tabId) {
              a.classList.add("text-[var(--primary-color)]");
              a.classList.remove("text-[var(--text-secondary)]");
            } else {
              a.classList.remove("text-[var(--primary-color)]");
              a.classList.add("text-[var(--text-secondary)]");
            }
          });
        }

        function showTab(tabId) {
          tabContents.forEach((tab) => tab.classList.remove("active"));
          const t = document.getElementById(tabId);
          if (t) t.classList.add("active");
          activateNav(tabId);
          // keep footer visible for all tabs (unless logged out)
          if (footer) footer.style.display = "block";
        }
        window.showTab = showTab;

        bottomTabs.forEach((btn) =>
          safeOn(btn, "click", (e) => {
            e.preventDefault();
            const tabId = btn.getAttribute("data-tab");
            if (tabId) showTab(tabId);
          })
        );

        // Trigger data loads on tab switch
        bottomTabs.forEach((btn) =>
          safeOn(btn, "click", (e) => {
            e.preventDefault();
            const tabId = btn.getAttribute("data-tab");
            if (tabId) {
              showTab(tabId);
              try {
                if (
                  tabId === "progress" &&
                  typeof updateProgressChart === "function"
                ) {
                  updateProgressChart();
                }
                if (
                  tabId === "home" &&
                  typeof pgLoadHomeDashboard === "function"
                ) {
                  pgLoadHomeDashboard();
                }
                if (tabId === "daily" && typeof loadToday === "function") {
                  const user = window.firebaseAuth?.auth?.currentUser;
                  if (user) loadToday(user.uid);
                }
              } catch (e) {
                console.warn("Tab data refresh:", e);
              }
            }
          })
        );
        // Quick actions from Home
        safeOn(document.getElementById("recalcBtn"), "click", () =>
          showTab("calculator")
        );
        safeOn(document.getElementById("quickAddBtn"), "click", () =>
          showTab("daily")
        );
        safeOn(document.getElementById("quickChallengeBtn"), "click", () =>
          showTab("challenges")
        );

        // --- Auth handlers ---
        const loginBtn = document.getElementById("loginBtn");
        const registerBtn = document.getElementById("registerBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const showRegister = document.getElementById("showRegister");
        const showLogin = document.getElementById("showLogin");
        const authMessage = document.getElementById("authMessage");

        safeOn(loginBtn, "click", async () => {
          const email = document.getElementById("loginEmail").value;
          const password = document.getElementById("loginPassword").value;
          try {
            await window.firebaseAuth.signInWithEmailAndPassword(
              email,
              password
            );
            if (authMessage) {
              authMessage.textContent = "Inicio de sesi√≥n exitoso!";
              authMessage.className = "mt-4 text-center text-green-500";
              authMessage.classList.remove("hidden");
            }
          } catch (error) {
            let message = "Error al iniciar sesi√≥n";
            if (error.code === "auth/invalid-email") message = "Email inv√°lido";
            if (error.code === "auth/user-not-found")
              message = "Usuario no encontrado";
            if (error.code === "auth/wrong-password")
              message = "Contrase√±a incorrecta";
            if (authMessage) {
              authMessage.textContent = message;
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
            }
          }
        });

        safeOn(registerBtn, "click", async () => {
          const email = document.getElementById("registerEmail").value;
          const password = document.getElementById("registerPassword").value;
          if (password.length < 6) {
            if (authMessage) {
              authMessage.textContent =
                "La contrase√±a debe tener al menos 6 caracteres";
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
            }
            return;
          }
          try {
            await window.firebaseAuth.createUserWithEmailAndPassword(
              email,
              password
            );
            if (authMessage) {
              authMessage.textContent = "Registro exitoso!";
              authMessage.className = "mt-4 text-center text-green-500";
              authMessage.classList.remove("hidden");
            }
            // swap to login
            const rf = document.getElementById("registerForm");
            const lf = document.getElementById("loginForm");
            if (rf) rf.classList.add("hidden");
            if (lf) lf.classList.remove("hidden");
          } catch (error) {
            let message = "Error al registrarse";
            if (error.code === "auth/email-already-in-use")
              message = "El email ya est√° en uso";
            if (error.code === "auth/invalid-email") message = "Email inv√°lido";
            if (error.code === "auth/weak-password")
              message = "Contrase√±a d√©bil";
            if (authMessage) {
              authMessage.textContent = message;
              authMessage.className = "mt-4 text-center text-red-500";
              authMessage.classList.remove("hidden");
            }
          }
        });

        safeOn(showRegister, "click", () => {
          const rf = document.getElementById("registerForm");
          const lf = document.getElementById("loginForm");
          if (lf) lf.classList.add("hidden");
          if (rf) rf.classList.remove("hidden");
          if (authMessage) authMessage.classList.add("hidden");
        });

        safeOn(showLogin, "click", () => {
          const rf = document.getElementById("registerForm");
          const lf = document.getElementById("loginForm");
          if (rf) rf.classList.add("hidden");
          if (lf) lf.classList.remove("hidden");
          if (authMessage) authMessage.classList.add("hidden");
        });

        safeOn(logoutBtn, "click", async () => {
          try {
            await window.firebaseAuth.signOut();
          } catch (e) {
            console.error(e);
          }
          tabContents.forEach((tab) => tab.classList.remove("active"));
          if (footer) footer.style.display = "none";
        });

        // --- Firebase readiness + auth state ---
        function waitForFirebaseReady(timeoutMs) {
          timeoutMs = timeoutMs || 8000;
          return new Promise((resolve, reject) => {
            const t0 = Date.now();
            (function check() {
              if (
                window.firebaseAuth &&
                window.firebaseAuth.firestore &&
                window.firebaseAuth.firestore.api
              )
                return resolve();
              if (Date.now() - t0 > timeoutMs)
                return reject(new Error("Firebase no inicializ√≥ a tiempo"));
              setTimeout(check, 40);
            })();
          });
        }

        function setLoggedInUI() {
          if (globalLoader) {
            globalLoader.style.opacity = "0";
            setTimeout(() => {
              globalLoader.style.display = "none";
            }, 500);
          }
          if (authSection) authSection.style.display = "none";
          if (header) header.style.display = "flex";
          if (footer) footer.style.display = "block";
          showTab("home");

          try {
            if (typeof showSectionLoader === "function")
              showSectionLoader("home");
          } catch (e) {}
          pgLoadHomeDashboard();
          pgRenderProgressScreen();
          if (typeof renderDailyCards === "function") renderDailyCards();
        }

        function setLoggedOutUI() {
          if (authSection) authSection.style.display = "block";
          tabContents.forEach((tab) => tab.classList.remove("active"));
          if (header) header.style.display = "none";
          if (footer) footer.style.display = "none";
        }

        waitForFirebaseReady()
          .then(() => {
            window.firebaseAuth.onAuthStateChanged(async (user) => {
              if (user) {
                // UI "logueado" normal
                setLoggedInUI();

                // Si ya mostramos el onboarding en esta sesi√≥n, no lo repitas
                if (sessionStorage.getItem("pg-onboarding-shown") === "1")
                  return;

                try {
                  const isNew = await shouldShowOnboarding(user.uid);
                  if (isNew) {
                    sessionStorage.setItem("pg-onboarding-shown", "1");
                    showOnboardingOverlay();
                  }
                } catch (e) {
                  console.warn("onboarding check:", e);
                }
              } else {
                setLoggedOutUI();
                sessionStorage.removeItem("pg-onboarding-shown");
              }
            });
          })
          .catch((e) => {
            console.error(e);
            setLoggedOutUI();
          });

        // --- Slider displays ---
        safeOn(driveDistance, "input", function () {
          if (drivingValue) drivingValue.textContent = `${this.value} km`;
        });
        safeOn(flightsPerYear, "input", function () {
          if (flightsValue) flightsValue.textContent = `${this.value} vuelos`;
        });
        safeOn(electricityUsage, "input", function () {
          if (electricityValue)
            electricityValue.textContent = `${this.value} kWh`;
        });

        // --- Tips filters ---
        const tipFilters = document.querySelectorAll(".tip-filter");
        const tipCards = document.querySelectorAll(".tip-card");
        tipFilters.forEach((btn) =>
          safeOn(btn, "click", function () {
            const category = this.getAttribute("data-category");
            tipFilters.forEach((b) => {
              b.classList.remove("active", "bg-primary", "text-white");
              b.classList.add(
                "bg-gray-200",
                "dark:bg-gray-700",
                "text-gray-800",
                "dark:text-white"
              );
            });
            this.classList.add("active", "bg-primary", "text-white");
            this.classList.remove(
              "bg-gray-200",
              "dark:bg-gray-700",
              "text-gray-800",
              "dark:text-white"
            );
            tipCards.forEach((card) => {
              const ok =
                category === "all" ||
                card.getAttribute("data-category") === category;
              card.style.display = ok ? "block" : "none";
            });
          })
        );

        // --- Chart + Calculate ---
        // Clasifica la huella anual en toneladas CO‚ÇÇe y devuelve label + texto
        function classifyFootprint(totalTonsRaw) {
          // Aseguramos que no sea negativo por restas (renovables, etc.)
          const t = Math.max(0, Number(totalTonsRaw) || 0);

          if (t <= 3) {
            return {
              tier: "baja",
              label: "Baja",
              text: "¬°Vas bien! Tu impacto es bajo, y podr√≠as reducirlo a√∫n m√°s. Cada acci√≥n cuenta, y vos ya est√°s marcando la diferencia.",
            };
          }
          if (t <= 5) {
            return {
              tier: "media",
              label: "Media",
              text: "Vas por un buen camino. Con un poco m√°s de conciencia, pod√©s convertirte en parte del cambio que necesitamos.",
            };
          }
          return {
            tier: "alta",
            label: "Alta",
            text: "Tu huella es m√°s alta que el promedio, pero nunca es tarde para mejorar. El cambio empieza con una decisi√≥n, y est√° en tus manos.",
          };
        }

        // Pinta el mensaje en el contenedor seg√∫n el tier
        function renderPersonalizedMessage(totalTons) {
          const host = document.getElementById("personalizedMessage");
          if (!host) return;

          const { tier, label, text } = classifyFootprint(totalTons);

          // Estilos por tier (claros y accesibles en light/dark)
          const classesByTier = {
            baja: "mt-4 rounded-lg px-4 py-3 text-sm bg-green-100 text-green-900 dark:bg-green-900/30 dark:text-green-200 border border-green-200/60 dark:border-green-800/60",
            media:
              "mt-4 rounded-lg px-4 py-3 text-sm bg-yellow-100 text-yellow-900 dark:bg-yellow-900/30 dark:text-yellow-200 border border-yellow-200/60 dark:border-yellow-800/60",
            alta: "mt-4 rounded-lg px-4 py-3 text-sm bg-red-100 text-red-900 dark:bg-red-900/30 dark:text-red-200 border border-red-200/60 dark:border-red-800/60",
          };

          host.className =
            classesByTier[tier] || "mt-4 px-4 py-3 text-sm rounded-lg";
          host.innerHTML = `<strong>${label}:</strong> ${text}`;
          host.classList.remove("hidden");
        }
        let footprintChart = null;
        function createFootprintChart(data) {
          const canvas = document.getElementById("footprintChart");
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          if (footprintChart) footprintChart.destroy();
          footprintChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: [
                "Transporte",
                "Energ√≠a en el Hogar",
                "Alimentaci√≥n",
                "Ropa",
                "Electr√≥nicos",
                "Residuos",
              ],
              datasets: [
                {
                  data,
                  backgroundColor: [
                    "#3498DB",
                    "#F1C40F",
                    "#2ECC71",
                    "#9B59B6",
                    "#FFA500",
                    "#E74C3C",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: "right" } },
            },
          });
        }

        function formatCategoryName(category) {
          const names = {
            transport: "Transporte",
            energy: "Energ√≠a",
            food: "Alimentaci√≥n",
            consumption: "Consumo",
            waste: "Residuos",
          };
          return names[category] || category;
        }
        function getImprovementSuggestion(category) {
          const suggestions = {
            transport: "Usa m√°s transporte p√∫blico o compartido.",
            energy: "Pasa a LED y electrodom√©sticos eficientes.",
            food: "Reduce porciones de carne roja.",
            consumption: "Compra menos y de mejor calidad.",
            waste: "Recicla mejor y consider√° compostar.",
          };
          return (
            suggestions[category] || "Busca reducir el consumo en esta √°rea."
          );
        }
        function generateImprovementAreas(d) {
          const target = document.getElementById("improvementAreas");
          if (!target) return;
          target.innerHTML = "";
          const categories = Object.entries(d).sort((a, b) => b[1] - a[1]);
          for (let i = 0; i < Math.min(3, categories.length); i++) {
            const [cat] = categories[i];
            const li = document.createElement("li");
            li.className = "text-gray-700 dark:text-gray-300";
            li.innerHTML = `<strong>${formatCategoryName(
              cat
            )}:</strong> ${getImprovementSuggestion(cat)}`;
            target.appendChild(li);
          }
        }

        // Home dashboard from Firestore (uses window.firebaseAuth.firestore.getFootprintHistory)
// === FIX HOME: normalizar datos, % del total de HOY y promedios correctos ===

// Mapeo de claves a espa√±ol (para unificar)
function toESKey(k) {
  const map = {
    transport: "transporte",
    energy: "energia",
    food: "alimentacion",
    waste: "residuos",
    clothing: "ropa",
    electronics: "electronica",
    consumption: "consumo",
  };
  const s = String(k || "").toLowerCase();
  return map[s] || s;
}
function addCat(acc, k, v) {
  const kk = toESKey(k);
  if (acc[kk] == null) acc[kk] = 0;
  acc[kk] += Number(v) || 0;
}

/**
 * Unifica TODO lo que haya en un d√≠a:
 * - totals.byCategory (diario)
 * - categories (calculadora/cuestionario)
 * - inputs[] (diario crudo)
 * Devuelve solo las 4 visibles en Home y el total correcto del d√≠a.
 */
function unifyDayTotals(day) {
  const raw = {};
  // 1) desde totals.byCategory
  const byCat = day?.totals?.byCategory || {};
  for (const [k, v] of Object.entries(byCat)) addCat(raw, k, v);

  // 2) desde categories (guardadas por la calculadora)
  const survey = day?.categories || {};
  for (const [k, v] of Object.entries(survey)) addCat(raw, k, v);

  // 3) desde inputs[] (registros diarios individuales)
  const inputs = Array.isArray(day?.inputs) ? day.inputs : [];
  for (const it of inputs) addCat(raw, it.category, it.co2e);

  // Solo las 4 del tablero Home
  const byCat4 = {
    transporte: raw.transporte || 0,
    energia: raw.energia || 0,
    alimentacion: raw.alimentacion || 0,
    residuos: raw.residuos || 0,
  };

  const explicitTotal = Number(day?.totals?.co2e ?? day?.total ?? 0);
  const sum = Object.values(byCat4).reduce((a, b) => a + Number(b || 0), 0);
  const total = explicitTotal > 0 ? explicitTotal : sum;

  return { byCat: byCat4, total };
}

/**
 * Promedios globales (kg CO‚ÇÇe/d√≠a) considerando calculadora + diario
 */
 function computeGlobalAverages(history) {
  const CAT_ES = ["transporte", "energia", "alimentacion", "residuos"];
  const sums = Object.fromEntries(CAT_ES.map((k) => [k, 0]));
  let dayCount = 0;
  let totalSum = 0;

  for (const day of history) {
    const byCat = (day?.totals?.byCategory) || {};
    const total = Number(day?.totals?.co2e ?? day?.total ?? 0) || 0;

    for (const k of CAT_ES) sums[k] += Number(byCat[k] || 0);
    totalSum += total;
    dayCount++;
  }

  const avgByCategory = Object.fromEntries(
    Object.entries(sums).map(([k, v]) => [k, dayCount ? v / dayCount : 0])
  );

  return {
    dayCount,
    avgByCategory,                   // kg CO‚ÇÇe/d√≠a por categor√≠a
    avgTotalPerDay: dayCount ? totalSum / dayCount : 0, // kg CO‚ÇÇe/d√≠a total
  };
}

/**
 * Tarjetas de desglose: ahora muestran % del total de HOY
 */
 function buildBreakdownCards(todayMap, todayTotal) {
  const cats = [
    { keyES: "transporte", label: "Transporte", icon: "directions_car", bg: "bg-blue-100",   color: "text-blue-600" },
    { keyES: "energia",    label: "Energ√≠a",    icon: "lightbulb",       bg: "bg-yellow-100", color: "text-yellow-600" },
    { keyES: "alimentacion",label: "Alimentaci√≥n",icon:"restaurant",     bg: "bg-red-100",    color: "text-red-600" },
    { keyES: "residuos",   label: "Residuos",   icon: "delete",          bg: "bg-purple-100", color: "text-purple-600" },
  ];

  return cats.map((c) => {
    const v = Number(todayMap?.[c.keyES] || 0);
    const pct = todayTotal > 0 ? Math.max(0, Math.min(100, (v / todayTotal) * 100)) : 0;

    return `
      <button class="pg-card w-full text-left rounded-2xl bg-white dark:bg-gray-900 pt-2 pb-3 px-3 shadow-sm focus:outline-none active:scale-[0.99] transition"
              data-keyes="${c.keyES}" data-label="${c.label}" data-icon="${c.icon}">
        <div class="flex flex-col leading-none">
          <div class="flex h-7 w-7 items-center justify-center rounded-full ${c.bg} ${c.color}">
            <span class="material-symbols-outlined text-[15px] leading-none">${c.icon}</span>
          </div>
          <span class="mt-[2px] font-semibold text-[var(--text-primary)] text-[14px] pt-2 pb-2 leading-none">${c.label}</span>
          <span class="mt-[2px] font-bold text-[16px] text-[var(--text-primary)] pt-2 pb-2 leading-none">${pct.toFixed(0)}%</span>
        </div>
        <div class="mt-1 h-[6px] w-full rounded-full bg-gray-200 overflow-hidden">
          <div class="h-[6px] bg-[var(--primary-color)]" style="width:${pct}%"></div>
        </div>
      </button>
    `;
  }).join("");
}


/**
 * Click en tarjeta ‚Üí abre detalle. Muestra:
 *  - Contribuci√≥n al total (HOY, suma con las dem√°s = huella actual)
 *  - Promedio (n d√≠as) combinando ambas fuentes
 *  - % del total de HOY
 */
 function attachBreakdownCardEvents(container, todayMap, todayTotal, averages) {
  const avgMap = averages?.avgByCategory || {};
  const dayCount = averages?.dayCount || 0;

  container.querySelectorAll(".pg-card").forEach((card) => {
    card.addEventListener("click", () => {
      const keyES = card.dataset.keyes;
      const label = card.dataset.label;
      const icon = card.dataset.icon;

      const today = Number(todayMap?.[keyES] || 0);          // valor de HOY desde totals.byCategory
      const avg   = Number(avgMap?.[keyES] || 0);            // promedio/d√≠a
      const pct   = todayTotal > 0 ? (today / todayTotal) * 100 : 0; // % del total de HOY

      showBreakdownBottomSheet({
        label,
        icon,
        today,
        avg,
        pct,
        dayCount,
      });
    });
  });
}


/**
 * Modal/bottom-sheet con los valores corregidos.
 * (Cambi√© el t√≠tulo de ese bloque a ‚Äú% del total de hoy‚Äù para que no confunda.)
 */
function showBreakdownBottomSheet({ label, icon, today, avg, pct, dayCount }) {
  let overlay = document.getElementById("pgModal");
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.id = "pgModal";
    overlay.className =
      "fixed inset-0 z-[100] bg-black/40 flex items-end sm:items-center justify-center";
    document.body.appendChild(overlay);
  }

  const pctClamped = (() => {
    const n = Number(pct);
    return Number.isFinite(n) ? Math.max(0, Math.min(100, n)) : 0;
  })();

  overlay.innerHTML = `
    <div class="w-full sm:max-w-md rounded-t-3xl sm:rounded-2xl bg-white dark:bg-gray-900 p-5 shadow-lg translate-y-0">
      <div class="flex items-start gap-3">
        <div class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 text-[var(--primary-color)]">
          <span class="material-symbols-outlined">${icon}</span>
        </div>
        <div class="flex-1">
          <p class="text-lg font-semibold text-[var(--text-primary)]">${label}</p>
          <p class="text-sm text-[var(--text-secondary)]">Detalle de emisiones</p>
        </div>
        <button id="pgModalClose" class="ml-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="mt-4 space-y-3">
        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3">
          <p class="text-xs text-[var(--text-secondary)]">Contribuci√≥n al total</p>
          <p class="text-base font-medium text-[var(--text-primary)]">
            ${today ? today.toFixed(2) + " kg CO‚ÇÇe" : "Sin datos"}
          </p>
        </div>

        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3">
          <p class="text-xs text-[var(--text-secondary)]">Promedio(${dayCount || 0} d√≠as)</p>
          <p class="text-base font-medium text-[var(--text-primary)]">
            ${avg ? avg.toFixed(2) + " kg CO‚ÇÇe" : "‚Äî"}
          </p>
        </div>

        <div class="rounded-xl border border-gray-200 dark:border-gray-800 p-3">
          <p class="text-xs text-[var(--text-secondary)]">% del total de hoy</p>
          <div class="flex items-end justify-between">
            <p class="text-xl font-semibold text-[var(--text-primary)]">${pctClamped.toFixed(0)}%</p>
            <div class="ml-4 w-2/3 h-2 rounded-full bg-gray-200 overflow-hidden">
              <div class="h-2 bg-[var(--primary-color)]" style="width:${pctClamped}%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  function close() {
    overlay.remove();
  }
  overlay.onclick = (e) => {
    if (e.target === overlay) close();
  };
  overlay.querySelector("#pgModalClose")?.addEventListener("click", close);
}

/**
 * Home: ahora usa el total UNIFICADO del √∫ltimo d√≠a
 * y muestra % por categor√≠a del total de HOY.
 */
async function pgLoadHomeDashboard() {
  const user = window.firebaseAuth?.auth?.currentUser;
  const totalEl = document.getElementById("homeTotal");
  const dateEl = document.getElementById("homeDate");
  const deltaChip = document.getElementById("homeDelta");
  const deltaText = document.getElementById("homeDeltaText");
  const breakdown = document.getElementById("homeBreakdown");
  if (!user || !breakdown || !totalEl) return;

  try {
    const history =
      await window.firebaseAuth.firestore.getFootprintHistory(user.uid);

    if (!history.length) {
      totalEl.textContent = "‚Äî";
      if (dateEl) dateEl.textContent = "‚Äî";
      breakdown.innerHTML = buildBreakdownCards(
        { transporte: 0, energia: 0, alimentacion: 0, residuos: 0 },
        0
      );
      return;
    }

    // Promedios (con ambas fuentes)
    const averages = computeGlobalAverages(history);

    const latest = history[0];
    const prev = history[1] || null;

    const todayMap   = (latest?.totals?.byCategory) || {};
    const todayTotal = Number(latest?.totals?.co2e ?? latest.total ?? 0) || 0;


    // Total y desgloses DEL D√çA (unificados)
    // const { byCat: todayMap, total: todayTotal } = unifyDayTotals(latest);

    // Fecha segura
    const date =
      latest.date ||
      (latest.timestamp
        ? new Date(
            latest.timestamp.seconds
              ? latest.timestamp.seconds * 1000
              : latest.timestamp
          )
            .toISOString()
            .substring(0, 10)
        : "");
    if (dateEl) dateEl.textContent = date || "‚Äî";

    // Huella actual = total de HOY unificado
    totalEl.textContent = todayTotal.toFixed(1);


    // Delta vs anterior (tambi√©n unificado)
    if (prev && deltaChip && deltaText) {
      const prevTotal = unifyDayTotals(prev).total || 0;
      const diff = prevTotal ? ((todayTotal - prevTotal) / prevTotal) * 100 : 0;
      deltaText.textContent = `${Math.abs(diff).toFixed(0)}% ${
        diff <= 0 ? "vs anterior" : "m√°s que anterior"
      }`;
      deltaChip.classList.remove("hidden");
      const icon = deltaChip.querySelector(".material-symbols-outlined");
      if (icon) icon.textContent = diff <= 0 ? "arrow_downward" : "arrow_upward";
    }

    // Desglose: % del total de HOY
    breakdown.innerHTML = buildBreakdownCards(todayMap, todayTotal);
    attachBreakdownCardEvents(breakdown, todayMap, todayTotal, averages);
  } catch (e) {
    console.error("Home dashboard error", e);
  }
}

        function pgRenderProgressScreen() {
          const ring = document.getElementById("pgRing");
          if (!ring) return;
          const daily = document.getElementById("pgDaily");
          const goal = document.getElementById("pgGoal");
          const rc = 45;
          const circ = 2 * Math.PI * rc;
          (async () => {
            const user = window.firebaseAuth?.auth?.currentUser;
            if (!user) {
              ring.style.strokeDasharray = circ;
              ring.style.strokeDashoffset = circ;
              return;
            }
            const today = new Date().toISOString().slice(0, 10);
            const docSnap = await window.getDaily(user.uid, today);
            const val = Number(docSnap?.totals?.co2e ?? 0);
            const g = 100;
            if (daily) daily.textContent = Math.round(val);
            if (goal) goal.textContent = g;
            const pct = Math.max(0, Math.min(100, (val / g) * 100));
            ring.style.strokeDasharray = circ;
            ring.style.strokeDashoffset = circ - (pct / 100) * circ;

            // change vs previous record
            try {
              const history =
                await window.firebaseAuth.firestore.getFootprintHistory(
                  user.uid
                );
              if (history.length > 1) {
                const a = Number(
                  history[0]?.totals?.co2e ?? history[0].total ?? 0
                );
                const b = Number(
                  history[1]?.totals?.co2e ?? history[1].total ?? 0
                );
                const diff = a - b;
                const pctc = b ? (diff / b) * 100 : 0;
                const changeEl = document.getElementById("pgChange");
                const changePct = document.getElementById("pgChangePct");
                const icon = document.getElementById("pgChangeIcon");
                if (changeEl)
                  changeEl.textContent =
                    (diff >= 0 ? "+" : "") + diff.toFixed(1);
                if (changePct)
                  changePct.textContent =
                    (pctc >= 0 ? "+" : "") + pctc.toFixed(0) + "%";
                if (icon) {
                  icon.textContent =
                    diff >= 0 ? "arrow_upward" : "arrow_downward";
                  icon.classList.toggle("text-red-500", diff >= 0);
                  icon.classList.toggle("text-green-500", diff < 0);
                }
              }
            } catch (e) {}
          })();
        }
        window.pgLoadHomeDashboard = pgLoadHomeDashboard;
        window.pgRenderProgressScreen = pgRenderProgressScreen;

        // Calculate and save
        safeOn(calculateBtn, "click", async function () {
          const driving = parseInt(driveDistance.value) * 0.0002;
          const flights = parseInt(flightsPerYear.value) * 0.5;
          const publicTransport =
            0.2 -
            parseInt(document.getElementById("publicTransport").value) * 0.05;
          const electricity = parseInt(electricityUsage.value) * 0.0005;
          const renewableEnergy =
            parseInt(document.getElementById("renewableEnergy").value) * 0.3;
          const dietImpact =
            parseInt(document.getElementById("dietType").value) * 0.5;
          const clothingImpact =
            parseInt(document.getElementById("clothingHabits").value) * 0.2;
          const electronicsImpact =
            parseInt(document.getElementById("electronicsHabits").value) * 0.3;
          const recyclingImpact =
            0.5 -
            parseInt(document.getElementById("recyclingHabits").value) * 0.15;

          const transportTotal = driving + flights + publicTransport;
          const energyTotal = electricity - renewableEnergy;
          const foodTotal = dietImpact;
          const consumptionTotal = clothingImpact + electronicsImpact;
          const wasteTotal = recyclingImpact;

          const total =
            Math.round(
              (transportTotal +
                energyTotal +
                foodTotal +
                consumptionTotal +
                wasteTotal) *
                10
            ) / 10;

          const totalEl = document.getElementById("totalCarbonFootprint");
          if (totalEl) totalEl.textContent = total;
          if (resultsSection) resultsSection.classList.remove("hidden");
          // Mostrar mensaje personalizado seg√∫n total (t CO‚ÇÇe/a√±o)
renderPersonalizedMessage(total);


          createFootprintChart([
            transportTotal,
            energyTotal,
            foodTotal,
            clothingImpact,
            electronicsImpact,
            wasteTotal,
          ]);
          generateImprovementAreas({
            transport: transportTotal,
            energy: energyTotal,
            food: foodTotal,
            consumption: consumptionTotal,
            waste: wasteTotal,
          });
          if (resultsSection)
            resultsSection.scrollIntoView({ behavior: "smooth" });

          // Save to Firestore if logged in
          const user = window.firebaseAuth?.auth?.currentUser;
          const saveResultsBtn = document.getElementById("saveResultsBtn");
          if (user) {
            const footprintData = {
              total: total,
              categories: {
                transport: transportTotal,
                energy: energyTotal,
                food: foodTotal,
                clothing: clothingImpact,
                electronics: electronicsImpact,
                waste: wasteTotal,
              },
              details: {
                driving: parseInt(driveDistance.value),
                flights: parseInt(flightsPerYear.value),
                publicTransport:
                  document.getElementById("publicTransport").value,
                electricity: parseInt(electricityUsage.value),
                renewableEnergy:
                  document.getElementById("renewableEnergy").value,
                dietType: document.getElementById("dietType").value,
                clothingHabits: document.getElementById("clothingHabits").value,
                electronicsHabits:
                  document.getElementById("electronicsHabits").value,
                recyclingHabits:
                  document.getElementById("recyclingHabits").value,
              },
              date: new Date().toISOString().split("T")[0],
              timestamp: new Date(),
            };
            try {
              if (saveResultsBtn) {
                saveResultsBtn.textContent = "Guardando...";
                saveResultsBtn.disabled = true;
              }
              await window.setInitialSurveyDone?.(
                user.uid,
                footprintData?.details
              );
              const ok = await window.firebaseAuth.firestore.saveFootprint(
                user.uid,
                footprintData
              );
              if (saveResultsBtn)
                saveResultsBtn.textContent = ok
                  ? "¬°Resultados Guardados!"
                  : "Error al guardar";
              pgLoadHomeDashboard();
              pgRenderProgressScreen();
              try {
                if (typeof showSectionLoader === "function")
                  showSectionLoader("progress");
              } catch (e) {}
              if (typeof updateProgressChart === "function")
                updateProgressChart();
              try {
                if (typeof hideSectionLoader === "function")
                  hideSectionLoader("progress");
              } catch (e) {}
              setTimeout(() => {
                if (saveResultsBtn) {
                  saveResultsBtn.textContent = "Guardar Resultados";
                  saveResultsBtn.disabled = false;
                }
              }, 1800);
            } catch (e) {
              console.error("Error al guardar huella:", e);
              if (saveResultsBtn) {
                saveResultsBtn.textContent = "Error al guardar";
                saveResultsBtn.disabled = false;
              }
            }
          } else {
            if (saveResultsBtn) {
              const original = saveResultsBtn.textContent;
              saveResultsBtn.textContent = "Inicia sesi√≥n para guardar";
              setTimeout(() => {
                saveResultsBtn.textContent = original;
              }, 1800);
            }
          }
        });

        // Buttons in results
        safeOn(document.getElementById("viewTipsBtn"), "click", () =>
          showTab("tips")
        );
        safeOn(document.getElementById("viewChallengesBtn"), "click", () =>
          showTab("challenges")
        );
        safeOn(document.getElementById("saveResultsBtn"), "click", () => {
          /* handled on calculate */
        });

        // Contact modal (guarded)
        const contactModal = document.getElementById("contactModal");
        safeOn(document.getElementById("closeContactModal"), "click", () => {
          if (contactModal) contactModal.classList.add("hidden");
        });
        if (contactModal)
          contactModal.addEventListener("click", (e) => {
            if (e.target === contactModal) contactModal.classList.add("hidden");
          });
        safeOn(document.getElementById("copyEmailBtn"), "click", () => {
          navigator.clipboard.writeText("powergreen_app@gmail.com");
        });

        // Hide everything except auth until auth state is known
        if (header) header.style.display = "none";
        if (footer) footer.style.display = "none";
        tabContents.forEach((tab) => tab.classList.remove("active"));
      });
    </script>

    <script>
      // ... (tus variables ya existentes)

      // Referencias Diario
      const dailySection = document.getElementById("daily");
      const dailyCarousel = document.getElementById("dailyCarousel");
      const dailySummary = document.getElementById("dailySummary");
      const dailyTotalEl = document.getElementById("dailyTotal");
      const dailyHint = document.getElementById("dailyHint");

      // Modal Diario
      const dailyModal = document.getElementById("dailyModal");
      const dailyModalClose = document.getElementById("dailyModalClose");
      const dailyModalIcon = document.getElementById("dailyModalIcon");
      const dailyModalTitle = document.getElementById("dailyModalTitle");
      const dailyModalDesc = document.getElementById("dailyModalDesc");
      const dailyModalInput = document.getElementById("dailyModalInput");
      const dailyModalUnit = document.getElementById("dailyModalUnit");
      const dailyModalSave = document.getElementById("dailyModalSave");

      // Categor√≠as (factores aproximados; ajusta con tus factores reales)
      const CATEGORIES = [
        {
          id: "transporte",
          label: "Transporte",
          unit: "km",
          factor: 0.121,
          icon: "üöó",
          hint: "Auto, moto o similar",
        },
        {
          id: "energia",
          label: "Energ√≠a",
          unit: "kWh",
          factor: 0.233,
          icon: "‚ö°",
          hint: "Consumo el√©ctrico",
        },
        {
          id: "alimentacion",
          label: "Alimentaci√≥n",
          unit: "comidas",
          factor: 2.5,
          icon: "üçΩÔ∏è",
          hint: "Estimaci√≥n por comida",
        },
        {
          id: "ropa",
          label: "Ropa",
          unit: "prendas",
          factor: 6.5,
          icon: "üëï",
          hint: "Compra/uso eventual",
        },
        {
          id: "electronica",
          label: "Electr√≥nica",
          unit: "h uso",
          factor: 0.05,
          icon: "üì±",
          hint: "Uso dispositivos",
        },
        {
          id: "residuos",
          label: "Residuos",
          unit: "kg",
          factor: 0.45,
          icon: "üóëÔ∏è",
          hint: "Desechos generados",
        },
      ];

      // Fecha YYYY-MM-DD
      const todayStr = () => new Date().toISOString().split("T")[0];
    </script>

    <script>
      function renderDailyCards() {
        if (!dailyCarousel) return;
        dailyCarousel.innerHTML = "";

        // Duplicamos el set de tarjetas para "sensaci√≥n" infinita
        const all = [...CATEGORIES, ...CATEGORIES];
        all.forEach((cat) => {
          const card = document.createElement("div");
          card.className = "pg-card";
          card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="tip-card bg-white dark:bg-gray-700 rounded-lg shadow p-4 border-l-4 border-yellow-500 pg-card-icon">${cat.icon}</div>
            <div>
              <h3 class="text-lg font-semibold">${cat.label}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">${cat.hint}</p>
            </div>
          </div>
          <button data-cat="${cat.id}" class="px-4 py-2 rounded-2xl bg-primary text-white font-medium hover:opacity-90">A√±adir</button>
        </div>
      `;
          dailyCarousel.appendChild(card);
        });

        // Listeners botones "A√±adir"
        dailyCarousel.querySelectorAll("button[data-cat]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const cat = CATEGORIES.find((c) => c.id === btn.dataset.cat);
            openDailyModal(cat);
          });
        });
      }

      function openDailyModal(cat) {
        if (!cat) return;
        dailyModalIcon.textContent = cat.icon;
        dailyModalTitle.textContent = `Registrar ${cat.label}`;
        dailyModalDesc.textContent = cat.hint;
        dailyModalInput.value = "";
        dailyModalUnit.textContent = `Unidad: ${cat.unit}`;
        dailyModal.dataset.cat = cat.id;
        dailyModal.classList.remove("hidden");
        dailyModal.classList.add("flex");
      }

      function closeDailyModal() {
        dailyModal.classList.add("hidden");
        dailyModal.classList.remove("flex");
      }

      dailyModalClose.addEventListener("click", closeDailyModal);
      dailyModal.addEventListener("click", (e) => {
        if (e.target === dailyModal) closeDailyModal();
      });
    </script>

    <script>
      async function ensureUserDoc(uid) {
        if (!DB || !uid) return;
        const ref = doc(DB, "users", uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(
            ref,
            {
              createdAt: new Date().toISOString(),
              preferences: { locale: "es-AR" },
              streak: { count: 0, lastEntryDate: null },
              initialSurvey: { completedAt: null },
            },
            { merge: true }
          );
        }
      }

      async function setInitialSurveyDone(uid, payload) {
        if (!DB || !uid) return;
        const ref = doc(DB, "users", uid);
        await setDoc(
          ref,
          {
            initialSurvey: {
              completedAt: new Date().toISOString(),
              answers: payload || null,
            },
          },
          { merge: true }
        );
      }

      async function getDaily(uid, dateStr) {
        const ref = doc(DB, "users", uid, "footprints", dateStr);
        const snap = await getDoc(ref);
        return snap.exists() ? snap.data() : null;
      }

      async function saveDaily(uid, cat, value) {
        const dateStr = todayStr();
        const catDef = CATEGORIES.find((c) => c.id === cat);
        if (!catDef) throw new Error("Categor√≠a inv√°lida");
        const co2e = Number(value) * catDef.factor;

        const ref = doc(DB, "users", uid, "footprints", dateStr);
        const current = await getDaily(uid, dateStr);

        const byCategory = Object.assign(
          {
            transporte: 0,
            energia: 0,
            alimentacion: 0,
            ropa: 0,
            electronica: 0,
            residuos: 0,
          },
          current?.totals?.byCategory || {}
        );
        byCategory[cat] = (byCategory[cat] || 0) + co2e;

        const inputs = Array.isArray(current?.inputs)
          ? current.inputs.slice()
          : [];
        inputs.push({
          category: cat,
          value: Number(value),
          unit: catDef.unit,
          co2e,
          note: null,
          source: "daily-card",
          at: new Date().toISOString(),
        });

        const total = Object.values(byCategory).reduce((a, b) => a + b, 0);

        const payload = {
          date: dateStr,
          timestamp: new Date().toISOString(),
          totals: { co2e: Number(total.toFixed(3)), byCategory },
          inputs,
        };

        await setDoc(ref, payload, { merge: true });

        // UI
        dailyTotalEl.textContent = `${payload.totals.co2e.toFixed(2)} kg CO‚ÇÇe`;
        dailyHint.textContent = `Actualizado: ${catDef.label} +${co2e.toFixed(
          2
        )} kg CO‚ÇÇe`;
      }

      dailyModalSave.addEventListener("click", async () => {
        const cat = dailyModal.dataset.cat;
        const value = Number(dailyModalInput.value);
        if (!cat || isNaN(value) || value < 0) return;

        const user = window.firebaseAuth?.auth?.currentUser;
        if (!user) {
          alert("Inicia sesi√≥n primero");
          return;
        }

        dailyModalSave.disabled = true;
        dailyModalSave.textContent = "Guardando‚Ä¶";

        try {
          await saveDaily(user.uid, cat, value);
          closeDailyModal();
        } catch (e) {
          console.error(e);
          alert("No se pudo guardar");
        } finally {
          dailyModalSave.disabled = false;
          dailyModalSave.textContent = "Guardar";
        }
      });
    </script>

    <div
      id="contactModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-primary">Contacto</h3>
          <button
            id="closeContactModal"
            class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <div class="flex items-center">
            <svg
              class="w-5 h-5 mr-3 text-primary"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
              ></path>
            </svg>
            <span>+54 379 4709835</span>
          </div>
          <div class="flex items-center">
            <svg
              class="w-5 h-5 mr-3 text-primary"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
              ></path>
              <path
                d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
              ></path>
            </svg>
            <span>powergreen_app@gmail.com</span>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button
            id="copyEmailBtn"
            class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg text-sm"
          >
            Copiar Email
          </button>
        </div>
      </div>
    </div>

    <!-- === PG minimal patch (no UI changes) === -->
    <script>
      (function () {
        if (window.__PG_PATCH_APPLIED__) return;
        window.__PG_PATCH_APPLIED__ = true;

        function waitForFirebaseReady(timeoutMs) {
          timeoutMs = timeoutMs || 8000;
          return new Promise(function (resolve, reject) {
            var t0 = Date.now();
            (function check() {
              if (
                window.firebaseAuth &&
                window.firebaseAuth.firestore &&
                window.firebaseAuth.firestore.api
              )
                return resolve();
              if (Date.now() - t0 > timeoutMs)
                return reject(
                  new Error("Firebase no inicializ√≥ a tiempo (patch)")
                );
              setTimeout(check, 30);
            })();
          });
        }

        function todayStr() {
          return new Date().toISOString().split("T")[0];
        }

        waitForFirebaseReady()
          .then(function () {
            var FAPI = window.firebaseAuth.firestore.api;
            var DB = window.firebaseAuth.firestore.db;
            var doc = FAPI.doc,
              setDoc = FAPI.setDoc,
              getDoc = FAPI.getDoc;

            // Exponer referencias
            window.PG = {
              DB: DB,
              FAPI: FAPI,
              doc: doc,
              setDoc: setDoc,
              getDoc: getDoc,
            };

            // --- Helpers (sobrescribir para que no fallen por DB undefined) ---
            window.ensureUserDoc = async function (uid) {
              if (!uid) return;
              var ref = doc(DB, "users", uid);
              var snap = await getDoc(ref);
              if (!snap.exists()) {
                await setDoc(
                  ref,
                  {
                    createdAt: new Date().toISOString(),
                    preferences: { locale: "es-AR" },
                    streak: { count: 0, lastEntryDate: null },
                    initialSurvey: { completedAt: null },
                  },
                  { merge: true }
                );
              }
            };

            window.setInitialSurveyDone = async function (uid, payload) {
              if (!uid) return;
              var ref = doc(DB, "users", uid);
              await setDoc(
                ref,
                {
                  initialSurvey: {
                    completedAt: new Date().toISOString(),
                    answers: payload || null,
                  },
                },
                { merge: true }
              );
            };

            window.getDaily = async function (uid, dateStr) {
              if (!uid) return null;
              var ref = doc(DB, "users", uid, "footprints", dateStr);
              var snap = await getDoc(ref);
              return snap.exists() ? snap.data() : null;
            };

            // Si existen categor√≠as en otro script, resp√©talas; sino definimos una m√≠nima por si las dudas.
            var CATEGORIES = window.CATEGORIES || [
              {
                id: "transporte",
                unit: "km",
                factor: 0.121,
                label: "Transporte",
              },
              { id: "energia", unit: "kWh", factor: 0.233, label: "Energ√≠a" },
              {
                id: "alimentacion",
                unit: "comidas",
                factor: 2.5,
                label: "Alimentaci√≥n",
              },
              { id: "residuos", unit: "kg", factor: 0.45, label: "Residuos" },
            ];

            window.saveDaily = async function (uid, cat, value) {
              if (!uid) return;
              var dateStr = todayStr();
              var catDef = (window.CATEGORIES || CATEGORIES).find(function (c) {
                return c.id === cat;
              });
              if (!catDef) throw new Error("Categor√≠a inv√°lida");
              var co2e = Number(value) * Number(catDef.factor || 0);

              var ref = doc(DB, "users", uid, "footprints", dateStr);
              var current = await window.getDaily(uid, dateStr);

              var byCategory = Object.assign(
                {
                  transporte: 0,
                  energia: 0,
                  alimentacion: 0,
                  ropa: 0,
                  electronica: 0,
                  residuos: 0,
                },
                (current && current.totals && current.totals.byCategory) || {}
              );
              byCategory[cat] = (byCategory[cat] || 0) + co2e;

              var inputs = Array.isArray(current && current.inputs)
                ? current.inputs.slice()
                : [];
              inputs.push({
                category: cat,
                value: Number(value),
                unit: catDef.unit || "",
                co2e: co2e,
                source: "daily-card",
                at: new Date().toISOString(),
              });

              var total = Object.keys(byCategory).reduce(function (a, k) {
                return a + (byCategory[k] || 0);
              }, 0);
              var payload = {
                date: dateStr,
                timestamp: new Date().toISOString(),
                totals: {
                  co2e: Number(total.toFixed(3)),
                  byCategory: byCategory,
                },
                inputs: inputs,
              };
              await setDoc(ref, payload, { merge: true });

              // Log requerido
              console.log("[Diario] Guardado hoy:", {
                categoria: cat,
                valor: value,
                co2e: co2e.toFixed(2),
                total: payload.totals.co2e.toFixed(2),
              });

              // Actualizar UI si existen esos nodos
              try {
                var totalEl = document.getElementById("dailyTotal");
                var hintEl = document.getElementById("dailyHint");
                if (totalEl)
                  totalEl.textContent =
                    payload.totals.co2e.toFixed(2) + " kg CO‚ÇÇe";
                if (hintEl)
                  hintEl.textContent =
                    "Actualizado: " +
                    (catDef.label || cat) +
                    " +" +
                    co2e.toFixed(2) +
                    " kg CO‚ÇÇe";
              } catch (e) {}
            };

            // Cargar consumo del d√≠a y log a consola
            window.loadToday = async function (uid) {
              var d = await window.getDaily(uid, todayStr());
              if (!d) {
                console.log("[Diario] Hoy sin registros.");
                var totalEl = document.getElementById("dailyTotal");
                var hintEl = document.getElementById("dailyHint");
                if (totalEl) totalEl.textContent = "0 kg CO‚ÇÇe";
                if (hintEl) hintEl.textContent = "A√∫n no registraste nada hoy.";
                return;
              }
              var total = (d.totals && d.totals.co2e) || 0;
              console.log("[Diario] Consumo de hoy:", d);
              try {
                var totalEl = document.getElementById("dailyTotal");
                var hintEl = document.getElementById("dailyHint");
                if (totalEl)
                  totalEl.textContent = Number(total).toFixed(2) + " kg CO‚ÇÇe";
                if (hintEl)
                  hintEl.textContent =
                    "√öltima actualizaci√≥n: " + (d.timestamp || "");
              } catch (e) {}
            };

            // Re-render diario cards si el proyecto ya las define; si no, no hacemos nada visual (respetar dise√±o)
            if (typeof window.renderDailyCards === "function") {
              // no toca dise√±o, solo aseguro que exista al menos una vez
              try {
                window.renderDailyCards();
              } catch (e) {}
            }

            // --- Progreso: sobreescribir de forma segura para que no llame window.progressChart ---
            window.updateProgressChart = async function () {
              var user =
                window.firebaseAuth &&
                window.firebaseAuth.auth &&
                window.firebaseAuth.auth.currentUser;
              if (!user) return;
              try {
                var history =
                  await window.firebaseAuth.firestore.getFootprintHistory(
                    user.uid
                  );

                // Map to entries with a valid Date and total
                function parseDateSafe(h) {
                  if (h.date) {
                    try {
                      return new Date(h.date + "T00:00:00");
                    } catch (e) {}
                  }
                  if (h.timestamp && typeof h.timestamp === "object") {
                    if (typeof h.timestamp.seconds === "number")
                      return new Date(h.timestamp.seconds * 1000);
                    try {
                      return new Date(h.timestamp);
                    } catch (e) {}
                  }
                  return null;
                }

                var items = history
                  .map(function (h) {
                    var d = parseDateSafe(h);
                    var total =
                      Number(h.totals.co2e || (h.totals && h.totals.co2e) || 0) || 0;
                    return { raw: h, date: d, total: total };
                  })
                  .filter(function (it) {
                    return it.date && !isNaN(it.date.getTime());
                  });

                // Sort: older on the left, newest (ideally 'hoy') on the right
                items.sort(function (a, b) {
                  return a.date - b.date;
                });

                // Labels relative to today: 'hoy', 'ayer', 'hace N d√≠as'
                var now = new Date();
                var today = new Date(
                  now.toISOString().slice(0, 10) + "T00:00:00"
                );
                function labelFor(d) {
                  var d0 = new Date(d.toISOString().slice(0, 10) + "T00:00:00");
                  var diff = Math.round((today - d0) / 86400000);
                  if (diff <= 0) return "hoy";
                  if (diff === 1) return "ayer";
                  if (diff === 2) return "hace 2 d√≠as";
                  return "hace " + diff + " d√≠as";
                }
                var labels = items.map(function (it) {
                  return labelFor(it.date);
                });
                var values = items.map(function (it) {
                  return Number(it.total || 0);
                });

                var noDataEl = document.getElementById("noProgressData");
                if (noDataEl)
                  noDataEl.style.display = values.length ? "none" : "block";

                var c = document.getElementById("progressChart");
                if (!c || !c.getContext) return;
                var ctx = c.getContext("2d");
                if (
                  window.pgProgressChart &&
                  typeof window.pgProgressChart.destroy === "function"
                ) {
                  window.pgProgressChart.destroy();
                }
                window.pgProgressChart = new Chart(ctx, {
                  type: "line",
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: "CO‚ÇÇe diario",
                        data: values,
                        tension: 0.3,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 3,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                      x: {
                        ticks: { autoSkip: true, maxRotation: 0 },
                        grid: { display: false },
                      },
                      y: { beginAtZero: true },
                    },
                  },
                });
              } catch (e) {
                console.error("Error en updateProgressChart:", e);
              }
            };

            // Hook adicional al login para cargar hoy + progreso (sin tocar tu onAuthStateChanged original)
            try {
              window.firebaseAuth.onAuthStateChanged(function (user) {
                if (user) {
                  window
                    .ensureUserDoc(user.uid)
                    .then(function () {
                      return window.loadToday(user.uid);
                    })
                    .then(function () {
                      return window.updateProgressChart();
                    })
                    .catch(function (e) {
                      console.warn("Patch post-login:", e);
                    });
                }
              });
            } catch (e) {}
          })
          .catch(function (e) {
            console.error(e);
          });
      })();
    </script>

    <script>
      (function () {
        const STORAGE_KEY = "pg-theme";
        const root = document.documentElement;
        const btn = document.getElementById("themeToggle");

        // 1) Aplicar preferencia guardada si existe; si no, seguir al sistema
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === "dark" || saved === "light") {
          root.classList.toggle("dark", saved === "dark");
        }
        // Si NO hay preferencia guardada, tu c√≥digo actual ya sigue al sistema (prefers-color-scheme)

        // 2) Toggle manual
        function updateIcon() {
          if (!btn) return;
          btn.textContent = root.classList.contains("dark") ? "üåô" : "‚òÄÔ∏è";
        }

        if (btn) {
          updateIcon();
          btn.addEventListener("click", () => {
            const isDark = root.classList.toggle("dark");
            localStorage.setItem(STORAGE_KEY, isDark ? "dark" : "light");
            updateIcon();
            // Si tu gr√°fico depende del tema, lo refrescamos:
            if (typeof updateProgressChart === "function")
              updateProgressChart();
          });
        }

        // 3) Si quieres que NO cambie con el sistema (solo respetar lo guardado),
        // comenta las siguientes dos l√≠neas en tu c√≥digo original:
        // window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ...)
      })();
    </script>

    <!-- === /PG minimal patch === -->

    <!-- === PG Daily override (stitch-styled) === -->
    <script>
      (function () {
        // Ensure toast container exists
        function ensureToast() {
          var toast = document.getElementById("dailyToast");
          if (!toast) {
            toast = document.createElement("div");
            toast.id = "dailyToast";
            toast.className =
              "fixed bottom-24 left-1/2 -translate-x-1/2 transform bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden";
            toast.textContent = "¬°A√±adido con √©xito!";
            document.body.appendChild(toast);
          }
          return toast;
        }
        function showToast(msg) {
          var t = ensureToast();
          t.textContent = msg || "¬°A√±adido con √©xito!";
          t.classList.remove("hidden");
          setTimeout(function () {
            t.classList.add("hidden");
          }, 1500);
        }

        // Map icons for Material Symbols
        var ICONS = {
          transporte: "directions_car",
          energia: "bolt",
          alimentacion: "restaurant",
          ropa: "checkroom",
          electronica: "devices",
          residuos: "delete",
        };

        // Enrich existing CATEGORIES with Material icon names (non-breaking)
        if (window.CATEGORIES && Array.isArray(window.CATEGORIES)) {
          window.CATEGORIES.forEach(function (c) {
            if (!c.mi) c.mi = ICONS[c.id] || "eco";
          });
        } else {
          // minimal fallback
          window.CATEGORIES = [
            {
              id: "transporte",
              label: "Transporte",
              unit: "km",
              factor: 0.121,
              mi: ICONS["transporte"],
              hint: "Auto, moto o similar",
            },
            {
              id: "energia",
              label: "Energ√≠a",
              unit: "kWh",
              factor: 0.233,
              mi: ICONS["energia"],
              hint: "Consumo el√©ctrico",
            },
            {
              id: "alimentacion",
              label: "Alimentaci√≥n",
              unit: "comidas",
              factor: 2.5,
              mi: ICONS["alimentacion"],
              hint: "Estimaci√≥n por comida",
            },
            {
              id: "ropa",
              label: "Ropa",
              unit: "prendas",
              factor: 6.5,
              mi: ICONS["ropa"],
              hint: "Compra/uso eventual",
            },
            {
              id: "electronica",
              label: "Electr√≥nica",
              unit: "h uso",
              factor: 0.05,
              mi: ICONS["electronica"],
              hint: "Uso dispositivos",
            },
            {
              id: "residuos",
              label: "Residuos",
              unit: "kg",
              factor: 0.45,
              mi: ICONS["residuos"],
              hint: "Desechos generados",
            },
          ];
        }

        // Override renderDailyCards with stitch-like UI (inputs inline)
        window.renderDailyCards = function renderDailyCards() {
          var dailyCarousel = document.getElementById("dailyCarousel");
          if (!dailyCarousel) return;

          dailyCarousel.innerHTML = "";
          var user =
            window.firebaseAuth &&
            window.firebaseAuth.auth &&
            window.firebaseAuth.auth.currentUser;

          // L√≠mites m√°ximos por categor√≠a (generosos pero no exorbitantes)
          var MAX = {
            transporte: 500, // km/d√≠a
            energia: 20, // kWh/d√≠a
            alimentacion: 8, // comidas/d√≠a
            ropa: 20, // prendas/d√≠a
            electronica: 24, // h uso/d√≠a
            residuos: 20, // kg/d√≠a
          };

          (window.CATEGORIES || []).forEach(function (cat) {
            var card = document.createElement("div");
            card.className =
              "pg-card bg-white dark:bg-gray-900 rounded-3xl p-6 shadow-sm";
            // A√±adimos un peque√±o elemento para mostrar aviso local si supera el m√°ximo
            var maxVal = MAX[cat.id] || "";

            // Info peque√±o solo para Energ√≠a (igual estilo que el tooltip en la calculadora)
            var infoHtml = "";
            if (cat.id === "energia") {
              infoHtml =
                '<span class="info-tooltip ml-2" data-info="Estimado de valores: Bajo ‚â§ 7 kWh/d√≠a ¬∑ Medio 8‚Äì12 kWh/d√≠a ¬∑ Alto ‚â• 13 kWh/d√≠a">' +
                '<svg class="w-4 h-4 inline text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">' +
                '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd"/></svg>' +
                "</span>";
            }

            card.innerHTML = [
              '<div class="flex h-full flex-col justify-between">',
              "<div>",
              '<div class="mb-4 flex items-center gap-4">',
              '<div class="flex size-12 items-center justify-center rounded-xl bg-[var(--surface-light)] dark:bg-gray-800 text-primary">',
              '<span class="material-symbols-outlined text-3xl">',
              cat.mi || "eco",
              "</span>",
              "</div>",
              "<div>",
              '<h3 class="text-lg font-bold text-ink dark:text-white">',
              cat.label || "",
              "</h3>",
              '<p class="text-sm text-gray-500">',
              (cat.hint || "") + infoHtml,
              "</p>",
              "</div>",
              "</div>",
              '<div class="relative mt-6">',
              '<input type="number" min="0" step="0.01" class="no-spinner w-full rounded-xl border-gray-200 bg-gray-50 dark:bg-gray-800 p-4 text-center text-2xl font-bold focus:border-primary focus:ring-primary" placeholder="0" data-max="' +
                maxVal +
                '" />',
              '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-lg text-gray-500">',
              cat.unit || "",
              "</span>",
              // aviso inline (hidden por defecto)
              '<div class="pg-input-warning mt-3 hidden text-sm"></div>',
              "</div>",
              "</div>",
              '<button class="mt-6 w-full rounded-xl bg-primary hover:bg-secondary text-white py-3 font-semibold transition-colors">A√±adir</button>',
              "</div>",
            ].join("");

            // Wire up add button
            var btn = card.querySelector("button");
            var input = card.querySelector("input");
            var warn = card.querySelector(".pg-input-warning");

            function showWarning(msg) {
              if (!warn) return;
              warn.classList.remove("hidden");
              warn.innerHTML =
                '<div class="rounded-md p-2 ' +
                (msg ? "bg-red-50 text-red-700 dark:bg-red-900/40" : "") +
                '"><strong>' +
                (msg || "") +
                "</strong></div>";
            }
            function hideWarning() {
              if (!warn) return;
              warn.classList.add("hidden");
              warn.innerHTML = "";
            }

            // Validaci√≥n en tiempo real (avisar si excede m√°ximo)
            input.addEventListener("input", function () {
              hideWarning();
              var v = Number(this.value);
              var m = Number(this.dataset.max || 0);
              if (!isNaN(v) && m > 0 && v > m) {
                showWarning(
                  "Valor muy alto para " +
                    (cat.label || cat.id) +
                    ". L√≠mite razonable: " +
                    m +
                    " " +
                    (cat.unit || "")
                );
              }
            });

            btn.addEventListener("click", function () {
              var val = Number(input.value);
              var m = Number(input.dataset.max || 0);
              if (isNaN(val) || val < 0) {
                input.focus();
                showWarning("Ingresa un n√∫mero v√°lido.");
                return;
              }
              if (m > 0 && val > m) {
                // Mensaje siguiendo est√©tica (claro y directo)
                showWarning(
                  "Has superado el l√≠mite razonable de " +
                    m +
                    " " +
                    (cat.unit || "") +
                    " para " +
                    (cat.label || cat.id) +
                    ". Si necesitas registrar m√°s, contacta soporte."
                );
                input.focus();
                return;
              }
              var user =
                window.firebaseAuth &&
                window.firebaseAuth.auth &&
                window.firebaseAuth.auth.currentUser;
              if (!user) {
                alert("Inicia sesi√≥n primero");
                return;
              }
              btn.disabled = true;
              var original = btn.textContent;
              btn.textContent = "Guardando‚Ä¶";
              hideWarning();
              window
                .saveDaily(user.uid, cat.id, val)
                .then(function () {
                  // Toast peque√±o consistente con la UI
                  var t = document.getElementById("dailyToast");
                  if (t) {
                    t.textContent =
                      "+" +
                      val +
                      " " +
                      (cat.unit || "") +
                      " en " +
                      (cat.label || "");
                    t.classList.remove("hidden");
                    setTimeout(function () {
                      t.classList.add("hidden");
                    }, 1400);
                  }
                  input.value = "";
                })
                .catch(function (e) {
                  console.error(e);
                  showWarning("No se pudo guardar. Intenta de nuevo.");
                })
                .finally(function () {
                  btn.disabled = false;
                  btn.textContent = original;
                });
            });

            dailyCarousel.appendChild(card);
          });
        };

        // Add floating QR button (visual only; no-op)
        function ensureQR() {
          if (document.getElementById("pgQR")) return;
          var fab = document.createElement("button");
          fab.id = "pgQR";
          fab.className =
            "fixed bottom-24 right-6 z-40 flex h-16 w-16 items-center justify-center rounded-2xl bg-accent text-black dark:text-white shadow-lg hover:scale-105 transition-transform";
          fab.innerHTML =
            '<span class="material-symbols-outlined text-3xl">qr_code_scanner</span>';
          fab.title = "Escanear QR (pr√≥ximamente)";
          document.body.appendChild(fab);
        }

        // Ensure initial UI bits after DOM
        document.addEventListener("DOMContentLoaded", function () {
          ensureToast();
          ensureQR();
          // If user already logged, render now; otherwise original onAuthStateChanged will call it
          if (typeof window.renderDailyCards === "function") {
            try {
              window.renderDailyCards();
            } catch (e) {}
          }
        });
      })();
    </script>
    <!-- === /PG Daily override === -->
    <!-- Fix: tooltips appended to body to avoid being cortadas por overflow -->
    <style>
      /* Disable the old CSS pseudo-tooltip so it no longer shows/gets clipped */
      .info-tooltip::after {
        display: none !important;
      }

      /* Styling for the body-appended tooltip */
      .pg-body-tooltip {
        position: fixed;
        z-index: 99999;
        background: #2c3e50;
        color: #fff;
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 13px;
        line-height: 1.3;
        max-width: 300px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
        pointer-events: none;
        transition: opacity 120ms ease;
        opacity: 1;
      }
    </style>

    <script>
      (function () {
        function createBodyTooltip(el) {
          var txt = el.getAttribute("data-info") || "";
          var t = document.createElement("div");
          t.className = "pg-body-tooltip";
          t.textContent = txt;
          document.body.appendChild(t);
          return t;
        }
        function positionTooltip(t, el) {
          if (!t || !el) return;
          var r = el.getBoundingClientRect();
          // center horizontally above element, but keep inside viewport
          var tw = t.offsetWidth || 200;
          var left = Math.max(
            8,
            Math.min(window.innerWidth - tw - 8, r.left + r.width / 2 - tw / 2)
          );
          // try above; if not enough space, show below
          var topAbove = r.top - (t.offsetHeight || 36) - 8;
          if (topAbove < 8) {
            // place below
            t.style.top = r.bottom + 8 + "px";
          } else {
            t.style.top = topAbove + "px";
          }
          t.style.left = left + "px";
        }

        function wire(el) {
          var tip = null;
          var hoverTimer = null;
          el.addEventListener("mouseenter", function () {
            // small delay to avoid flicker
            hoverTimer = setTimeout(function () {
              tip = createBodyTooltip(el);
              // position after appended
              setTimeout(function () {
                positionTooltip(tip, el);
              }, 8);
            }, 60);
          });
          el.addEventListener("mousemove", function () {
            if (tip) positionTooltip(tip, el);
          });
          el.addEventListener("mouseleave", function () {
            if (hoverTimer) {
              clearTimeout(hoverTimer);
              hoverTimer = null;
            }
            if (tip) {
              tip.remove();
              tip = null;
            }
          });
          el.addEventListener("click", function () {
            if (hoverTimer) {
              clearTimeout(hoverTimer);
              hoverTimer = null;
            }
            if (tip) {
              tip.remove();
              tip = null;
            }
          });
        }

        function init() {
          // wire existing ones now
          document.querySelectorAll(".info-tooltip").forEach(wire);
          // observe future additions (cards re-render)
          if (window.MutationObserver) {
            var mo = new MutationObserver(function () {
              document
                .querySelectorAll(".info-tooltip:not([data-pg-wired])")
                .forEach(function (el) {
                  el.setAttribute("data-pg-wired", "1");
                  wire(el);
                });
            });
            mo.observe(document.body, { childList: true, subtree: true });
          }
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          init();
        }
      })();
    </script>

    <style>
      :root {
        --primary-color: #254d32;
        --secondary-color: #6b7f5b;
        --accent-color: #a3b18a;
        --text-primary: #1f3d2b;
        --text-secondary: #4b5563;
        --surface: #f8ebcf;
      }
      .dark {
        --primary-color: #a3b18a;
        --secondary-color: #6b7f5b;
        --accent-color: #254d32;
        --text-primary: #f8ebcf;
        --text-secondary: #9ca3af;
        --surface: #111827;
      }
      body {
        padding-bottom: 5.25rem;
      }
      #bottomNav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 40;
      }
      #quickAddBtn {
        color: #fff !important;
      }

      #bottomNav .material-symbols-outlined {
        font-variation-settings: "OPSZ" 20;
      }
      main.container {
        padding-bottom: 1rem;
      }
    </style>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        function waitForFirebaseReady(timeoutMs) {
          timeoutMs = timeoutMs || 8000;
          return new Promise((resolve, reject) => {
            const t0 = Date.now();
            (function check() {
              const ok =
                window.firebaseAuth &&
                window.firebaseAuth.firestore &&
                window.firebaseAuth.firestore.api;
              if (ok) return resolve(window.firebaseAuth.firestore);
              if (Date.now() - t0 > timeoutMs)
                return reject(new Error("Firebase no inicializ√≥ (enh)"));
              setTimeout(check, 40);
            })();
          });
        }
        async function pickHomeTip() {
          try {
            const user = window.firebaseAuth?.auth?.currentUser;
            if (!user) return;
            const history =
              await window.firebaseAuth.firestore.getFootprintHistory(user.uid);
            if (!history.length) return;
            const latest = history[0] || {};
            const cats = latest.categories || latest?.totals?.byCategory || {};
            const t = Number(cats.transport ?? cats.transporte ?? 0);
            const e = Number(cats.energy ?? cats.energia ?? 0);
            const f = Number(cats.food ?? cats.alimentacion ?? 0);
            const c =
              Number(cats.consumption ?? 0) +
              Number(cats.clothing ?? cats.ropa ?? 0) +
              Number(cats.electronics ?? cats.electronica ?? 0);
            const w = Number(cats.waste ?? cats.residuos ?? 0);
            const arr = [
              ["transport", t],
              ["energy", e],
              ["food", f],
              ["consumption", c],
              ["waste", w],
            ].sort((a, b) => b[1] - a[1]);
            const topCat = arr[0][1] > 0 ? arr[0][0] : null;
            if (!topCat) return;
            const pool = $$(
              '#tipsList .tip-card[data-category="' + topCat + '"]'
            );
            if (!pool.length) return;
            const choice = pool[Math.floor(Math.random() * pool.length)];
            let host = document.getElementById("homeSmartTip");
            if (!host) {
              const target = $("#home section:nth-of-type(4) .rounded-2xl");
              if (target) {
                target.id = "homeSmartTip";
                host = target;
              }
            }
            if (!host) return;
            host.className =
              "flex flex-col items-start rounded-2xl bg-white dark:bg-gray-900 p-5 shadow-sm";
            host.innerHTML =
              "" +
              '<div class="flex items-center justify-between w-full mb-2">' +
              '<div class="flex items-center gap-2">' +
              '<span class="material-symbols-outlined text-2xl text-[var(--accent-color)]">eco</span>' +
              '<span class="text-sm font-medium text-gray-500">Recomendado para tu mayor impacto</span>' +
              "</div>" +
              '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800">' +
              topCat +
              "</span>" +
              "</div>" +
              '<h4 class="text-lg font-semibold mb-1">' +
              (choice.querySelector("h3")?.textContent || "Consejo") +
              "</h4>" +
              '<p class="text-sm text-gray-600 dark:text-gray-300">' +
              (choice.querySelector("p")?.textContent || "") +
              "</p>";
          } catch (e) {
            console.warn("SmartTip:", e);
          }
        }
        (function () {
          const orig = window.pgLoadHomeDashboard;
          window.pgLoadHomeDashboard = async function () {
            try {
              if (orig) await orig();
            } catch (e) {}
            try {
              await pickHomeTip();
            } catch (e) {}
          };
        })();
        const BADGES = [
          { id: "seed", name: "Semilla", threshold: 50, icon: "eco" },
          {
            id: "sprout",
            name: "Brote",
            threshold: 150,
            icon: "local_florist",
          },
          { id: "tree", name: "√Årbol", threshold: 300, icon: "park" },
          { id: "forest", name: "Bosque", threshold: 600, icon: "forest" },
        ];
        async function getUserMeta(uid, api) {
          const { doc, getDoc } = api;
          const ref = doc(
            window.firebaseAuth.firestore.db,
            "users",
            uid,
            "meta",
            "profile"
          );
          const snap = await getDoc(ref);
          return snap.exists() ? snap.data() : { points: 0, badges: [] };
        }
        async function setUserMeta(uid, payload, api) {
          const { doc, setDoc } = api;
          const ref = doc(
            window.firebaseAuth.firestore.db,
            "users",
            uid,
            "meta",
            "profile"
          );
          await setDoc(ref, payload, { merge: true });
        }
        async function addUserPoints(uid, pts, api) {
          const meta = await getUserMeta(uid, api);
          const newPts = Number(meta.points || 0) + Number(pts || 0);
          await setUserMeta(uid, { points: newPts }, api);
          return newPts;
        }
        function renderBadges(points) {
          const host = $("#progress .flex.gap-3.p-1.flex-wrap");
          if (!host) return;
          host.innerHTML = "";
          BADGES.forEach((b) => {
            if (points >= b.threshold) {
              const chip = document.createElement("div");
              chip.className =
                "flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[var(--accent-color,#287a4a)]/20 pl-3 pr-4";
              chip.innerHTML =
                '<span class="material-symbols-outlined text-[var(--primary-color)]">' +
                b.icon +
                "</span>" +
                '<p class="text-[var(--primary-color)] text-sm font-medium">' +
                b.name +
                "</p>";
              host.appendChild(chip);
            }
          });
        }
        async function updatePointsAndBadges() {
          try {
            const user = window.firebaseAuth?.auth?.currentUser;
            if (!user) return;
            const api = window.firebaseAuth.firestore.api;
            const meta = await getUserMeta(user.uid, api);
            const points = Number(meta.points || 0);
            const el = document.getElementById("pgPoints");
            if (el) el.textContent = points;
            renderBadges(points);
          } catch (e) {
            console.warn("points/badges:", e);
          }
        }
        (function () {
          const orig = window.pgRenderProgressScreen;
          window.pgRenderProgressScreen = async function () {
            try {
              if (typeof orig === "function") await orig();
            } catch (e) {}
            try {
              await updatePointsAndBadges();
            } catch (e) {}
          };
        })();
        const CHALLENGE_CATALOG = {
          "meatless-week": {
            id: "meatless-week",
            name: "Semana Sin Carne",
            durationDays: 7,
            points: 100,
            category: "food",
          },
          "no-car-days": {
            id: "no-car-days",
            name: "D√≠as Sin Auto",
            durationDays: 5,
            points: 120,
            category: "transport",
          },
          "zero-waste-weekend": {
            id: "zero-waste-weekend",
            name: "Fin de Semana Cero Residuos",
            durationDays: 2,
            points: 60,
            category: "waste",
          },
          "energy-saver-month": {
            id: "energy-saver-month",
            name: "Mes de Ahorro de Energ√≠a",
            durationDays: 30,
            points: 300,
            category: "energy",
          },
          "no-new-stuff-month": {
            id: "no-new-stuff-month",
            name: "Mes Sin Compras Nuevas",
            durationDays: 30,
            points: 240,
            category: "consumption",
          },
          "water-saver": {
            id: "water-saver",
            name: "Ahorrador de Agua",
            durationDays: 14,
            points: 160,
            category: "energy",
          },
        };
        function todayStr() {
          return new Date().toISOString().slice(0, 10);
        }
        function addDays(dateStr, n) {
          const d = new Date(dateStr + "T00:00:00");
          d.setDate(d.getDate() + n);
          return d.toISOString().slice(0, 10);
        }
        async function joinChallenge(chId) {
          const user = window.firebaseAuth?.auth?.currentUser;
          if (!user) {
            alert("Inicia sesi√≥n para unirte a un reto");
            return;
          }
          const api = window.firebaseAuth.firestore.api;
          const db = window.firebaseAuth.firestore.db;
          const { doc, setDoc, getDoc } = api;
          const def = CHALLENGE_CATALOG[chId];
          if (!def) return;
          const start = todayStr();
          const ref = doc(db, "users", user.uid, "challenges", chId);
          const snap = await getDoc(ref);
          if (snap.exists() && snap.data()?.status === "active") {
            await renderActiveChallenges();
            return;
          }
          const payload = {
            id: def.id,
            name: def.name,
            durationDays: def.durationDays,
            points: def.points,
            category: def.category,
            startDate: start,
            endDate: addDays(start, def.durationDays - 1),
            progressDays: 0,
            lastProgressDate: null,
            status: "active",
            createdAt: new Date().toISOString(),
          };
          await setDoc(ref, payload, { merge: true });
          await renderActiveChallenges();
        }
        async function markChallengeDay(chId) {
          const user = window.firebaseAuth?.auth?.currentUser;
          if (!user) return;
          const api = window.firebaseAuth.firestore.api;
          const db = window.firebaseAuth.firestore.db;
          const { doc, setDoc, getDoc } = api;
          const ref = doc(db, "users", user.uid, "challenges", chId);
          const snap = await getDoc(ref);
          if (!snap.exists()) return;
          const data = snap.data();
          const today = todayStr();
          if (data.lastProgressDate === today) return; // 1 vez por d√≠a
          let progressDays = Number(data.progressDays || 0) + 1;
          let status =
            progressDays >= Number(data.durationDays) ? "completed" : "active";
          const update = { progressDays, lastProgressDate: today, status };
          if (status === "completed" && !data.completedAt)
            update.completedAt = today;
          await setDoc(ref, update, { merge: true });
          if (status === "completed") {
            await addUserPoints(user.uid, Number(data.points || 0), api);
          }
          await renderActiveChallenges();
          await updatePointsAndBadges();
        }
        function renderProgressBar(pct) {
          pct = Math.max(0, Math.min(100, pct));
          return (
            '<div class="w-full h-2 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden">' +
            '<div class="h-2 bg-[var(--primary-color)]" style="width:' +
            pct +
            '%"></div>' +
            "</div>"
          );
        }
        async function renderActiveChallenges() {
          const host = document.getElementById("activeChallengesTodo");
          if (!host) return;
          const user = window.firebaseAuth?.auth?.currentUser;
          if (!user) {
            host.innerHTML =
              '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Inicia sesi√≥n para ver tus retos.</p>';
            return;
          }
          const api = window.firebaseAuth.firestore.api,
            db = window.firebaseAuth.firestore.db;
          const { collection, getDocs } = api;
          const qref = collection(db, "users", user.uid, "challenges");
          const snaps = await getDocs(qref);
          const items = [];
          snaps.forEach((d) => items.push(d.data()));
          if (!items.length) {
            host.innerHTML =
              '<p class="text-gray-500 dark:text-gray-400 text-center py-4">A√∫n no te has unido a ning√∫n reto.</p>';
            return;
          }
          items.sort(
            (a, b) =>
              (a.status === "active" ? 0 : 1) - (b.status === "active" ? 0 : 1)
          );
          host.innerHTML = items
            .map((it) => {
              const pct = Math.round(
                (Number(it.progressDays || 0) / Number(it.durationDays || 1)) *
                  100
              );
              const statusPill =
                it.status === "completed"
                  ? '<span class="ml-2 text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100">Completado</span>'
                  : '<span class="ml-2 text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100">Activo</span>';
              return (
                "" +
                '<div class="rounded-lg border border-gray-200 dark:border-gray-700 p-4">' +
                '<div class="flex items-start justify-between">' +
                "<div>" +
                '<h4 class="font-semibold">' +
                (it.name || it.id) +
                "</h4>" +
                '<p class="text-xs text-gray-500">Inicio: ' +
                (it.startDate || "‚Äî") +
                " ¬∑ Fin: " +
                (it.endDate || "‚Äî") +
                statusPill +
                "</p>" +
                "</div>" +
                '<div class="text-right">' +
                '<p class="text-xs">Puntos: <strong>' +
                Number(it.points || 0) +
                "</strong></p>" +
                '<p class="text-xs">D√≠as: ' +
                Number(it.progressDays || 0) +
                "/" +
                Number(it.durationDays || 0) +
                "</p>" +
                "</div>" +
                "</div>" +
                '<div class="mt-3">' +
                renderProgressBar(pct) +
                "</div>" +
                (it.status === "active"
                  ? '<button data-mark="' +
                    it.id +
                    '" class="mt-3 w-full rounded-md bg-primary text-white py-2 text-sm">Marcar d√≠a cumplido</button>'
                  : '<p class="mt-3 text-sm text-green-600">¬°Reto completado! Puntos acreditados.</p>') +
                "</div>"
              );
            })
            .join("");
          $$("#activeChallengesTodo button[data-mark]").forEach((btn) => {
            btn.addEventListener("click", () =>
              markChallengeDay(btn.getAttribute("data-mark"))
            );
          });
        }
        function wireJoinButtons() {
          $$(".join-challenge-btn[data-id]").forEach((btn) => {
            btn.addEventListener("click", () =>
              joinChallenge(btn.getAttribute("data-id"))
            );
          });
        }
        document.addEventListener("DOMContentLoaded", async function () {
          wireJoinButtons();
          try {
            await waitForFirebaseReady();
            window.firebaseAuth.onAuthStateChanged((u) => {
              if (u) {
                renderActiveChallenges();
                updatePointsAndBadges();
              }
            });
          } catch (e) {
            console.warn(e);
          }
        });
        window.pgChallenges = {
          joinChallenge,
          renderActiveChallenges,
          markChallengeDay,
        };
      })();
    </script>

    <!-- === PG Section Loaders & Enhancements === -->
    <script>
      (function () {
        const IDS = [
          "home",
          "daily",
          "progress",
          "tips",
          "challenges",
          "calculator",
        ];
        const LOADER_HTML =
          '<div class="section-loader hidden"><div class="pg-spinner"></div></div>';
        function ensureLoader(id) {
          const sec = document.getElementById(id);
          if (!sec) return null;
          sec.style.position = sec.style.position || "relative";
          let ov = sec.querySelector(":scope > .section-loader");
          if (!ov) {
            const div = document.createElement("div");
            div.className = "section-loader hidden";
            div.innerHTML = '<div class="pg-spinner"></div>';
            sec.appendChild(div);
            ov = div;
          }
          return ov;
        }

        function showSectionLoader(id) {
          const sec = document.getElementById(id);
          if (!sec) return;
          let ov = sec.querySelector(":scope > .section-loader");
          if (!ov) {
            ov = document.createElement("div");
            ov.className =
              "section-loader absolute inset-0 bg-black/5 dark:bg-white/5 backdrop-blur-sm flex items-center justify-center z-20";
            ov.innerHTML =
              '<div class="animate-spin rounded-full h-10 w-10 border-4 border-[var(--primary-color)] border-t-transparent"></div>';
            sec.style.position = sec.style.position || "relative";
            sec.prepend(ov);
          } else {
            ov.classList.remove("hidden");
          }
          // Auto-hide safeguard after 4s
          if (window._sectionLoaderTimers[id])
            clearTimeout(window._sectionLoaderTimers[id]);
          window._sectionLoaderTimers[id] = setTimeout(
            () => hideSectionLoader(id),
            4000
          );
        }

        function hideSectionLoader(id) {
          const sec = document.getElementById(id);
          if (!sec) return;
          if (window._sectionLoaderTimers && window._sectionLoaderTimers[id]) {
            clearTimeout(window._sectionLoaderTimers[id]);
            delete window._sectionLoaderTimers[id];
          }
          const ov = sec.querySelector(":scope > .section-loader");
          if (ov) ov.classList.add("hidden");
        }

        window.showSectionLoader = showSectionLoader;
        window.hideSectionLoader = hideSectionLoader;

        window._sectionLoaderTimers = {};
        document.addEventListener("DOMContentLoaded", () => {
          IDS.forEach(ensureLoader);
        });

        // Wrap existing loaders around async functions without altering their bodies
        function wrapAsync(name, id) {
          const orig = window[name];
          if (typeof orig !== "function") return;
          window[name] = async function () {
            showSectionLoader(id);
            try {
              return await orig.apply(this, arguments);
            } finally {
              hideSectionLoader(id);
            }
          };
        }
        // Wrap known functions
        wrapAsync("pgLoadHomeDashboard", "home");
        wrapAsync("pgRenderProgressScreen", "progress");
        wrapAsync("updateProgressChart", "progress");
      })();
    </script>

    <script>
      (function () {
        function applyOvershootUI() {
          const dailyEl = document.getElementById("pgDaily");
          const goalEl = document.getElementById("pgGoal");
          if (!dailyEl || !goalEl) return;

          const wrap = dailyEl.parentElement; // the <p> containing a/b
          const daily = Number(
            (dailyEl.textContent || "0").replace(/[^\d.]/g, "")
          );
          const goal = Number(
            (goalEl.textContent || "0").replace(/[^\d.]/g, "")
          );

          if (daily > goal) {
            if (!wrap.dataset.orig) {
              wrap.dataset.orig = wrap.innerHTML;
            }

            // Crear mensaje mejorado con emoji y mejor styling
            wrap.innerHTML = `
      <div class="flex flex-col items-center justify-center text-center">
        <span class="material-symbols-outlined text-grey-500 text-3xl mb-1">warning</span>
        <span class="text-red-400 font-bold text-sm leading-tight">
          ¬°Te has pasado!
        </span>
        <span class="text-red-400 font-bold text-xs mt-0.5">
          ${daily}/${goal}
        </span>
      </div>
    `;
          } else {
            // Restaurar contenido original
            if (wrap.dataset.orig) {
              wrap.innerHTML = wrap.dataset.orig;
              wrap.dataset.orig = "";
            }
          }
        }
        // Hook render
        const orig = window.pgRenderProgressScreen;
        window.pgRenderProgressScreen = async function () {
          if (typeof orig === "function") await orig();
          applyOvershootUI();
        };
        document.addEventListener("DOMContentLoaded", applyOvershootUI);

        // Observe changes to daily/goal to re-apply the UI if values change later
        const dailyEl = document.getElementById("pgDaily");
        const goalEl = document.getElementById("pgGoal");
        if (dailyEl && goalEl && window.MutationObserver) {
          const obs = new MutationObserver(() => applyOvershootUI());
          obs.observe(dailyEl, {
            subtree: true,
            characterData: true,
            childList: true,
          });
          obs.observe(goalEl, {
            subtree: true,
            characterData: true,
            childList: true,
          });
        }
      })();
    </script>

    <script>
      (function () {
        const origSaveDaily = window.saveDaily;
        window.saveDaily = async function (uid, cat, value) {
          try {
            window.showSectionLoader && window.showSectionLoader("daily");
          } catch (e) {}
          try {
            return await origSaveDaily.apply(this, arguments);
          } finally {
            try {
              window.hideSectionLoader && window.hideSectionLoader("daily");
            } catch (e) {}
          }
        };
      })();
    </script>
    <!-- === Onboarding overlay (solo para usuarios sin huella) === -->
    <div
      id="onboardingOverlay"
      class="fixed inset-0 z-[100] bg-black/70 hidden"
    >
      <iframe
        id="onboardingFrame"
        src="onboarding.html?embed=1"
        class="w-full h-full border-0 bg-surface"
      ></iframe>
    </div>
  </body>
</html>
